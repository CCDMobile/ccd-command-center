<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCD Channel Manager v2.3 - Shared File Support</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    
    <!-- Shared File Helper (inline for standalone compatibility) -->
    <script>
    const CCDSharedFiles = (function() {
        const SHARED_DB_NAME = 'ccd-shared-files';
        const SHARED_DB_VERSION = 1;
        const SHARED_STORE_NAME = 'file-handles';
        let db = null;
        
        async function initDB() {
            if (db) return db;
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(SHARED_DB_NAME, SHARED_DB_VERSION);
                request.onerror = () => resolve(null);
                request.onsuccess = () => { db = request.result; resolve(db); };
                request.onupgradeneeded = (e) => {
                    const database = e.target.result;
                    if (!database.objectStoreNames.contains(SHARED_STORE_NAME)) {
                        database.createObjectStore(SHARED_STORE_NAME);
                    }
                };
            });
        }
        
        async function getHandle(key) {
            try {
                await initDB();
                if (!db) return null;
                return new Promise((resolve) => {
                    const tx = db.transaction([SHARED_STORE_NAME], 'readonly');
                    const store = tx.objectStore(SHARED_STORE_NAME);
                    const request = store.get(key);
                    request.onsuccess = async () => {
                        const handle = request.result;
                        if (!handle) { resolve(null); return; }
                        try {
                            const perm = await handle.queryPermission({ mode: 'readwrite' });
                            resolve(perm === 'granted' ? handle : null);
                        } catch (e) { resolve(null); }
                    };
                    request.onerror = () => resolve(null);
                });
            } catch (e) { return null; }
        }
        
        return {
            getMasterJson: () => getHandle('masterJson'),
            getSyncData: () => getHandle('syncData'),
            getConfigFile: () => getHandle('configFile'),
            getOneDriveFolder: () => getHandle('oneDriveFolder')
        };
    })();
    </script>
    
    <style>
        :root {
            --bg-dark: #0c1222; --bg-card: #141d2f; --bg-input: #1a2540; --bg-hover: #1e2d4a;
            --border: #2a3f5f; --text: #e2e8f0; --text-dim: #8892a6; --text-muted: #5a6478;
            --etsy: #f56400; --etsy-bg: rgba(245,100,0,0.15);
            --wix: #0061ff; --wix-bg: rgba(0,97,255,0.15);
            --wayfair: #9333ea; --wayfair-bg: rgba(147,51,234,0.15);
            --success: #22c55e; --success-bg: rgba(34,197,94,0.15);
            --warning: #eab308; --error: #ef4444; --info: #3b82f6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg-dark); color: var(--text); min-height: 100vh; }
        
        .header { background: var(--bg-card); border-bottom: 1px solid var(--border); padding: 0 24px; height: 60px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .logo { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 1.1rem; }
        .logo-icon { width: 36px; height: 36px; background: linear-gradient(135deg, #8b5cf6, #6366f1); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .header-nav { display: flex; gap: 4px; margin-left: 32px; }
        .nav-btn { padding: 8px 16px; border-radius: 6px; border: none; background: transparent; color: var(--text-dim); font-family: inherit; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .nav-btn:hover { background: var(--bg-hover); color: var(--text); }
        .nav-btn.active { background: var(--bg-input); color: var(--text); }
        .header-right { display: flex; align-items: center; gap: 12px; }
        
        .btn { padding: 8px 16px; border-radius: 6px; border: none; font-family: inherit; font-size: 0.85rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s; }
        .btn-primary { background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(139,92,246,0.4); }
        .btn-secondary { background: var(--bg-input); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--bg-hover); }
        .btn-etsy { background: var(--etsy); color: white; }
        .btn-wix { background: var(--wix); color: white; }
        .btn-wayfair { background: var(--wayfair); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        
        .main { display: flex; height: calc(100vh - 60px); }
        .sidebar { width: 320px; background: var(--bg-card); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .sidebar-header { padding: 16px; border-bottom: 1px solid var(--border); }
        .search-box { width: 100%; padding: 10px 12px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: inherit; font-size: 0.9rem; }
        .search-box:focus { outline: none; border-color: #8b5cf6; }
        .search-box::placeholder { color: var(--text-muted); }
        .filter-row { display: flex; gap: 8px; margin-top: 12px; }
        .filter-btn { flex: 1; padding: 6px; border-radius: 4px; border: 1px solid var(--border); background: transparent; color: var(--text-dim); font-size: 0.75rem; font-weight: 500; cursor: pointer; }
        .filter-btn:hover { background: var(--bg-hover); }
        .filter-btn.active { background: var(--bg-input); color: var(--text); border-color: #8b5cf6; }
        .product-list { flex: 1; overflow-y: auto; padding: 8px; }
        .product-item { padding: 12px; border-radius: 8px; cursor: pointer; margin-bottom: 4px; border: 1px solid transparent; transition: all 0.2s; }
        .product-item:hover { background: var(--bg-hover); }
        .product-item.selected { background: var(--bg-input); border-color: #8b5cf6; }
        .product-name { font-weight: 600; font-size: 0.9rem; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .product-sku { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px; }
        .product-channels { display: flex; gap: 4px; }
        .channel-dot { width: 8px; height: 8px; border-radius: 50%; }
        .channel-dot.etsy { background: var(--etsy); }
        .channel-dot.wix { background: var(--wix); }
        .channel-dot.wayfair { background: var(--wayfair); }
        .channel-dot.none { background: var(--text-muted); }
        
        .content { flex: 1; overflow-y: auto; padding: 24px; }
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-dim); }
        .empty-state-icon { font-size: 4rem; margin-bottom: 16px; opacity: 0.5; }
        .empty-state-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 8px; }
        
        .product-detail { display: none; }
        .product-detail.active { display: block; }
        .detail-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; }
        .detail-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 4px; }
        .detail-sku { font-family: 'JetBrains Mono', monospace; color: var(--text-dim); font-size: 0.9rem; }
        .detail-actions { display: flex; gap: 8px; }
        
        .channel-grid { display: grid; grid-template-columns: 180px repeat(3, 1fr); gap: 1px; background: var(--border); border-radius: 12px; overflow: hidden; margin-bottom: 24px; }
        .channel-grid-header { background: var(--bg-card); padding: 14px 16px; font-weight: 600; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; }
        .channel-grid-header.etsy { border-top: 3px solid var(--etsy); }
        .channel-grid-header.wix { border-top: 3px solid var(--wix); }
        .channel-grid-header.wayfair { border-top: 3px solid var(--wayfair); }
        .channel-status { font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; margin-left: auto; }
        .channel-status.connected { background: var(--success-bg); color: var(--success); }
        .channel-status.not-listed { background: var(--bg-input); color: var(--text-muted); }
        .field-label { background: var(--bg-card); padding: 12px 16px; font-weight: 500; font-size: 0.85rem; color: var(--text-dim); }
        .field-cell { background: var(--bg-dark); padding: 12px 16px; font-size: 0.85rem; }
        .field-cell.empty { color: var(--text-muted); font-style: italic; }
        .field-value { max-height: 60px; overflow: hidden; }
        
        .quick-actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
        .quick-action-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s; }
        .quick-action-card:hover { transform: translateY(-2px); }
        .quick-action-card.etsy:hover { border-color: var(--etsy); }
        .quick-action-card.wix:hover { border-color: var(--wix); }
        .quick-action-card.wayfair:hover { border-color: var(--wayfair); }
        .quick-action-icon { font-size: 1.5rem; margin-bottom: 12px; }
        .quick-action-title { font-weight: 600; margin-bottom: 4px; }
        .quick-action-desc { font-size: 0.8rem; color: var(--text-dim); }
        
        .sync-panel { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); margin-bottom: 24px; }
        .sync-panel-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .sync-panel-title { font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .sync-panel-body { padding: 20px; }
        .sync-row { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .sync-row:last-child { border-bottom: none; }
        .sync-field-name { width: 140px; font-weight: 500; color: var(--text-dim); }
        .sync-checkboxes { display: flex; gap: 24px; flex: 1; }
        .sync-checkbox { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .sync-checkbox input { width: 18px; height: 18px; cursor: pointer; accent-color: #8b5cf6; }
        .sync-checkbox-label { font-size: 0.85rem; display: flex; align-items: center; gap: 6px; }
        .sync-checkbox-label .dot { width: 8px; height: 8px; border-radius: 50%; }
        .sync-checkbox-label .dot.etsy { background: var(--etsy); }
        .sync-checkbox-label .dot.wix { background: var(--wix); }
        .sync-checkbox-label .dot.wayfair { background: var(--wayfair); }
        .sync-actions { display: flex; gap: 12px; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border); }
        
        /* DASHBOARD STYLES */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 32px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 24px; }
        .stat-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
        .stat-card-title { font-size: 0.85rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        .stat-card-icon { font-size: 2rem; opacity: 0.7; }
        .stat-value { font-size: 2.5rem; font-weight: 700; margin-bottom: 8px; }
        .stat-label { font-size: 0.85rem; color: var(--text-dim); }
        .stat-change { font-size: 0.8rem; margin-top: 8px; }
        .stat-change.positive { color: var(--success); }
        
        .channel-status-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 32px; }
        .channel-status-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 24px; position: relative; overflow: hidden; }
        .channel-status-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
        .channel-status-card.etsy::before { background: var(--etsy); }
        .channel-status-card.wix::before { background: var(--wix); }
        .channel-status-card.wayfair::before { background: var(--wayfair); }
        .channel-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .channel-name { font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .connection-status { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; padding: 4px 10px; border-radius: 12px; }
        .connection-status.connected { background: var(--success-bg); color: var(--success); }
        .connection-status.disconnected { background: rgba(239,68,68,0.15); color: var(--error); }
        .connection-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
        .channel-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; }
        .mini-stat { text-align: center; }
        .mini-stat-value { font-size: 1.8rem; font-weight: 700; margin-bottom: 4px; }
        .mini-stat-label { font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
        .channel-actions { display: flex; gap: 8px; }
        
        .quick-sync-section { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 32px; }
        .section-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 16px; }
        .sync-options { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
        .sync-option { background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.2s; }
        .sync-option:hover { border-color: #8b5cf6; background: var(--bg-hover); }
        .sync-option-title { font-weight: 600; margin-bottom: 4px; }
        .sync-option-desc { font-size: 0.85rem; color: var(--text-dim); }
        
        /* MULTI-CHANNEL PUSH MODAL */
        .channel-checkboxes { display: flex; flex-direction: column; gap: 12px; margin: 20px 0; }
        .channel-checkbox-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .channel-checkbox-item:hover { background: var(--bg-hover); }
        .channel-checkbox-item input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .channel-checkbox-label { flex: 1; display: flex; align-items: center; gap: 8px; font-weight: 500; }
        .channel-checkbox-status { font-size: 0.75rem; padding: 2px 8px; border-radius: 10px; background: var(--bg-dark); color: var(--text-dim); }
        
        /* IMAGE PREVIEW */
        .image-preview-section { margin: 20px 0; padding: 16px; background: var(--bg-input); border-radius: 8px; }
        .image-preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; margin-top: 12px; }
        .image-preview-item { position: relative; aspect-ratio: 1; border-radius: 8px; overflow: hidden; border: 2px solid var(--border); }
        .image-preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .image-preview-placeholder { display: flex; align-items: center; justify-content: center; background: var(--bg-dark); color: var(--text-muted); font-size: 2rem; height: 100%; }
        .image-count { font-size: 0.85rem; color: var(--text-dim); margin-top: 8px; }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; width: 90%; max-width: 600px; max-height: 85vh; overflow: hidden; transform: translateY(20px); transition: transform 0.3s; }
        .modal-overlay.active .modal { transform: translateY(0); }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .modal-title { font-size: 1.2rem; font-weight: 700; }
        .modal-close { width: 32px; height: 32px; border-radius: 6px; border: none; background: var(--bg-input); color: var(--text-dim); cursor: pointer; font-size: 1.2rem; }
        .modal-close:hover { background: var(--error); color: white; }
        .modal-body { padding: 20px; overflow-y: auto; max-height: calc(85vh - 140px); }
        .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 8px; }
        
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-weight: 500; margin-bottom: 8px; color: var(--text-dim); }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 10px 12px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: inherit; font-size: 0.9rem; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #8b5cf6; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        
        .settings-section { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 20px; overflow: hidden; }
        .settings-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; }
        .settings-icon { width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .settings-icon.etsy { background: var(--etsy-bg); }
        .settings-icon.wix { background: var(--wix-bg); }
        .settings-icon.wayfair { background: var(--wayfair-bg); }
        .settings-body { padding: 20px; }
        .connection-status { display: flex; align-items: center; gap: 10px; padding: 12px 16px; background: var(--bg-input); border-radius: 8px; margin-top: 16px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .status-dot.connected { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .status-dot.disconnected { background: var(--error); }
        
        .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 2000; display: flex; flex-direction: column; gap: 8px; }
        .toast { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 12px 16px; display: flex; align-items: center; gap: 10px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--error); }
        .toast.warning { border-left: 3px solid var(--warning); }
        .toast.info { border-left: 3px solid var(--info); }
        
        .view { display: none; }
        .view.active { display: block; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

        /* WAYFAIR ORDERS VIEW STYLES */
        .wayfair-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .wayfair-stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; text-align: center; }
        .wayfair-stat-value { font-size: 2rem; font-weight: 700; color: var(--wayfair); }
        .wayfair-stat-label { font-size: 0.85rem; color: var(--text-dim); margin-top: 4px; }
        .order-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 16px; overflow: hidden; }
        .order-card-header { padding: 16px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
        .order-card-header:hover { background: var(--bg-hover); }
        .order-card-body { display: none; padding: 20px; border-top: 1px solid var(--border); background: var(--bg-dark); }
        .order-card.expanded .order-card-body { display: block; }
        .order-po { font-weight: 700; font-size: 1.1rem; color: var(--wayfair); }
        .order-meta { font-size: 0.85rem; color: var(--text-dim); margin-top: 4px; display: flex; gap: 16px; flex-wrap: wrap; }
        .order-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .order-badge.new { background: var(--wayfair-bg); color: var(--wayfair); }
        .order-badge.accepted { background: var(--success-bg); color: var(--success); }
        .order-customer { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .customer-info h4 { font-size: 0.9rem; color: var(--text-dim); margin-bottom: 8px; }
        .order-items-table { width: 100%; border-collapse: collapse; margin: 16px 0; }
        .order-items-table th, .order-items-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
        .order-items-table th { color: var(--text-dim); font-weight: 500; font-size: 0.85rem; background: var(--bg-card); }
        .order-actions { display: flex; gap: 12px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }
        .env-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .env-badge.sandbox { background: var(--warning); color: #000; }
        .env-badge.production { background: var(--success); color: #fff; }
        .connection-alert { background: rgba(239,68,68,0.15); border: 1px solid var(--error); border-radius: 8px; padding: 16px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }
        .connection-alert-icon { font-size: 1.5rem; }
        .connection-alert-text { flex: 1; }
        .connection-alert-text strong { display: block; margin-bottom: 4px; }
        .spinner { width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--wayfair); border-radius: 50%; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .status-dot.checking { background: var(--warning); animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .modal.lg { max-width: 700px; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <div class="logo"><div class="logo-icon">&#128225;</div><span>Channel Manager v2.3.2 ‚Ä¢ Build: 2026-01-20 20:10</span></div>
            <nav class="header-nav">
                <button class="nav-btn active" data-view="dashboard" onclick="switchView('dashboard')">üìä Dashboard</button>
                <button class="nav-btn" data-view="products" onclick="switchView('products')">üì¶ Products</button>
                <button class="nav-btn" data-view="orders" onclick="switchView('orders')">üõí Orders</button>
                <button class="nav-btn" data-view="compare" onclick="switchView('compare')">üîÑ Compare & Sync</button>
                <button class="nav-btn" data-view="sync" onclick="switchView('sync')">Sync Queue</button>
                <button class="nav-btn" data-view="settings" onclick="switchView('settings')">Settings</button>
            </nav>
        </div>
        <div class="header-right">
            <span class="env-badge sandbox" id="wayfairEnvBadge">üß™ Sandbox</span>
            <button class="btn btn-secondary" onclick="refreshData()">&#8635; Refresh</button>
            <button class="btn btn-primary" onclick="openProductEditor('create')">+ Create Listing</button>
            <button class="btn btn-secondary" onclick="openInventory()">&#8592; Inventory</button>
        </div>
    </header>
    
    <main class="main">
        <aside class="sidebar">
            <div class="sidebar-header">
                <input type="text" class="search-box" id="searchInput" placeholder="Search products..." oninput="filterProducts()">
                <div class="filter-row">
                    <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">All</button>
                    <button class="filter-btn" data-filter="etsy" onclick="setFilter('etsy')">Etsy</button>
                    <button class="filter-btn" data-filter="wix" onclick="setFilter('wix')">Wix</button>
                    <button class="filter-btn" data-filter="wayfair" onclick="setFilter('wayfair')">Wayfair</button>
                </div>
                <div style="margin-top: 8px; display: flex; gap: 4px;">
                    <button class="btn-secondary" style="flex: 1; font-size: 0.75rem;" onclick="connectMasterFile()" title="Select master JSON file">
                        üìÅ Connect File
                    </button>
                    <button class="btn-secondary" style="flex: 1; font-size: 0.75rem;" onclick="refreshData()" title="Reload from connected file or localStorage">
                        üîÑ Reload
                    </button>
                </div>
                <div id="fileStatus" style="margin-top: 6px; font-size: 0.7rem; color: var(--text-muted); text-align: center; padding: 4px;"></div>
            </div>
            <div class="product-list" id="productList"></div>
        </aside>
        
        <div class="content">
            <!-- DASHBOARD VIEW -->
            <div id="dashboardView" class="view active">
                <h2 style="margin-bottom: 24px;">üìä Channel Sync Dashboard</h2>
                
                <!-- Overview Stats -->
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-card-title">Total Products</span>
                            <span class="stat-card-icon">üì¶</span>
                        </div>
                        <div class="stat-value" id="dashTotalProducts">0</div>
                        <div class="stat-label">in inventory</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-card-title">Listed Products</span>
                            <span class="stat-card-icon">‚úÖ</span>
                        </div>
                        <div class="stat-value" id="dashListedProducts">0</div>
                        <div class="stat-label">across all channels</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-card-title">Pending Syncs</span>
                            <span class="stat-card-icon">‚è≥</span>
                        </div>
                        <div class="stat-value" id="dashPendingSyncs">0</div>
                        <div class="stat-label">in queue</div>
                    </div>
                    <div class="stat-card" style="border-left: 3px solid #667eea;">
                        <div class="stat-card-header">
                            <span class="stat-card-title">Sync Hub Status</span>
                            <span class="stat-card-icon">üîÑ</span>
                        </div>
                        <div class="stat-value" id="dashSyncHubStatus" style="font-size: 1rem; color: var(--text-dim);">Unknown</div>
                        <div class="stat-label" id="dashSyncHubLastSeen">Not checked</div>
                    </div>
                </div>
                
                <!-- Sync Hub Alert Banner (shown when Sync Hub is down) -->
                <div id="syncHubAlertBanner" style="display: none; background: rgba(239,68,68,0.15); border: 1px solid var(--error); border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 2rem;">‚ö†Ô∏è</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--error);">Sync Hub Not Responding</div>
                            <div style="font-size: 0.85rem; color: var(--text-dim);" id="syncHubAlertDetails">Auto-sync may not be running. Check PC3.</div>
                        </div>
                        <button class="btn btn-sm btn-secondary" onclick="checkSyncHubStatus()">üîÑ Check Again</button>
                    </div>
                </div>
                
                <!-- Channel Status Cards -->
                <div class="channel-status-grid">
                    <!-- Etsy Card -->
                    <div class="channel-status-card etsy">
                        <div class="channel-header">
                            <div class="channel-name">üé® Etsy</div>
                            <div class="connection-status" id="dashEtsyStatus">
                                <span class="connection-dot"></span>
                                <span>Not Connected</span>
                            </div>
                        </div>
                        <div class="channel-stats">
                            <div class="mini-stat">
                                <div class="mini-stat-value" id="dashEtsyListed">0</div>
                                <div class="mini-stat-label">Listed</div>
                            </div>
                            <div class="mini-stat">
                                <div class="mini-stat-value" id="dashEtsyPending">0</div>
                                <div class="mini-stat-label">Pending</div>
                            </div>
                        </div>
                        <div class="channel-actions">
                            <button class="btn btn-sm btn-etsy" onclick="testEtsy()" style="flex: 1;">Test Connection</button>
                            <button class="btn btn-sm btn-secondary" onclick="switchView('settings')">Configure</button>
                        </div>
                    </div>
                    
                    <!-- Wix Card -->
                    <div class="channel-status-card wix">
                        <div class="channel-header">
                            <div class="channel-name">üåê Wix</div>
                            <div class="connection-status" id="dashWixStatus">
                                <span class="connection-dot"></span>
                                <span>Not Connected</span>
                            </div>
                        </div>
                        <div class="channel-stats">
                            <div class="mini-stat">
                                <div class="mini-stat-value" id="dashWixListed">0</div>
                                <div class="mini-stat-label">Listed</div>
                            </div>
                            <div class="mini-stat">
                                <div class="mini-stat-value" id="dashWixPending">0</div>
                                <div class="mini-stat-label">Pending</div>
                            </div>
                        </div>
                        <div class="channel-actions">
                            <button class="btn btn-sm btn-wix" onclick="testWix()" style="flex: 1;">Test Connection</button>
                            <button class="btn btn-sm btn-secondary" onclick="switchView('settings')">Configure</button>
                        </div>
                    </div>
                    
                    <!-- Wayfair Card -->
                    <div class="channel-status-card wayfair">
                        <div class="channel-header">
                            <div class="channel-name">üè† Wayfair</div>
                            <div class="connection-status" id="dashWayfairStatus">
                                <span class="connection-dot"></span>
                                <span>Not Connected</span>
                            </div>
                        </div>
                        <div class="channel-stats">
                            <div class="mini-stat">
                                <div class="mini-stat-value" id="dashWayfairListed">0</div>
                                <div class="mini-stat-label">Listed</div>
                            </div>
                            <div class="mini-stat">
                                <div class="mini-stat-value" id="dashWayfairPending">0</div>
                                <div class="mini-stat-label">Pending</div>
                            </div>
                        </div>
                        <div class="channel-actions">
                            <button class="btn btn-sm btn-wayfair" onclick="testWayfair()" style="flex: 1;">Test Connection</button>
                            <button class="btn btn-sm btn-secondary" onclick="switchView('settings')">Configure</button>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Sync Section -->
                <div class="quick-sync-section">
                    <h3 class="section-title">üöÄ Quick Actions</h3>
                    <div class="sync-options">
                        <div class="sync-option" onclick="switchView('products')">
                            <div class="sync-option-title">üì¶ Manage Products</div>
                            <div class="sync-option-desc">View and push products to channels</div>
                        </div>
                        <div class="sync-option" onclick="switchView('sync')">
                            <div class="sync-option-title">‚è≥ View Sync Queue</div>
                            <div class="sync-option-desc">Monitor pending operations</div>
                        </div>
                        <div class="sync-option" onclick="switchView('wayfairOrders')">
                            <div class="sync-option-title">üõí Wayfair Orders</div>
                            <div class="sync-option-desc">Process incoming orders</div>
                        </div>
                        <div class="sync-option" onclick="refreshDashboard()">
                            <div class="sync-option-title">üîÑ Refresh Dashboard</div>
                            <div class="sync-option-desc">Update all stats and statuses</div>
                        </div>
                    </div>
                </div>
                
                <!-- Import & Link Section -->
                <div class="import-section" style="background: linear-gradient(135deg, rgba(241,173,89,0.1), rgba(139,92,246,0.1)); border: 1px solid rgba(241,173,89,0.3); border-radius: 12px; padding: 20px; margin-top: 20px;">
                    <h3 class="section-title" style="margin-bottom: 16px;">üîó Import & Link Products</h3>
                    <p style="color: var(--text-dim); margin-bottom: 16px; font-size: 0.9rem;">
                        Pull existing listings from channels and link them to your Master JSON by SKU. This prevents duplicate listings.
                    </p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
                        <!-- Import from Etsy -->
                        <div style="background: var(--bg-card); border-radius: 8px; padding: 16px; border: 1px solid var(--border);">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                                <span style="font-size: 1.5rem;">üé®</span>
                                <div>
                                    <div style="font-weight: 600; color: var(--etsy);">Import from Etsy</div>
                                    <div style="font-size: 0.8rem; color: var(--text-dim);">Link existing Etsy listings</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-sm btn-etsy" onclick="importFromEtsy()" style="flex: 1;">üì• Import All</button>
                                <button class="btn btn-sm btn-secondary" onclick="previewEtsyImport()">üëÅÔ∏è Preview</button>
                            </div>
                            <div id="etsyImportStatus" style="margin-top: 8px; font-size: 0.8rem; color: var(--text-dim);"></div>
                        </div>
                        
                        <!-- Import from Wix -->
                        <div style="background: var(--bg-card); border-radius: 8px; padding: 16px; border: 1px solid var(--border);">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                                <span style="font-size: 1.5rem;">üåê</span>
                                <div>
                                    <div style="font-weight: 600; color: var(--wix);">Import from Wix</div>
                                    <div style="font-size: 0.8rem; color: var(--text-dim);">Link existing Wix products</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-sm btn-wix" onclick="importFromWix()" style="flex: 1;">üì• Import All</button>
                                <button class="btn btn-sm btn-secondary" onclick="previewWixImport()">üëÅÔ∏è Preview</button>
                            </div>
                            <div id="wixImportStatus" style="margin-top: 8px; font-size: 0.8rem; color: var(--text-dim);"></div>
                        </div>
                        
                        <!-- Import from Wayfair -->
                        <div style="background: var(--bg-card); border-radius: 8px; padding: 16px; border: 1px solid var(--border);">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                                <span style="font-size: 1.5rem;">üè†</span>
                                <div>
                                    <div style="font-weight: 600; color: var(--wayfair);">Import from Wayfair</div>
                                    <div style="font-size: 0.8rem; color: var(--text-dim);">Link existing Wayfair items</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-sm btn-wayfair" onclick="importFromWayfair()" style="flex: 1;">üì• Import All</button>
                                <button class="btn btn-sm btn-secondary" onclick="previewWayfairImport()">üëÅÔ∏è Preview</button>
                            </div>
                            <div id="wayfairImportStatus" style="margin-top: 8px; font-size: 0.8rem; color: var(--text-dim);"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="productsView" class="view">
                <div id="emptyState" class="empty-state">
                    <div class="empty-state-icon">&#128230;</div>
                    <div class="empty-state-title">Select a product</div>
                    <div>Choose a product from the list to view and sync across channels</div>
                </div>
                
                <div id="productDetail" class="product-detail">
                    <div class="detail-header">
                        <div>
                            <h1 class="detail-title" id="detailTitle">Product Name</h1>
                            <div class="detail-sku" id="detailSku">SKU: 12345</div>
                        </div>
                        <div class="detail-actions">
                            <button class="btn btn-secondary btn-sm" onclick="openProductEditor('edit')">‚úèÔ∏è Edit Product</button>
                            <button class="btn btn-primary btn-sm" onclick="openMultiChannelPush()">üöÄ Push to Channels</button>
                            <button class="btn btn-secondary btn-sm" onclick="scrollToSync()">&#128260; Sync</button>
                        </div>
                    </div>
                    
                    <!-- MASTER DATA INFO - Always shows product info from master JSON -->
                    <div id="masterDataPanel" style="background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(59,130,246,0.1)); border: 1px solid rgba(139,92,246,0.3); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                        <div style="font-weight: 600; color: var(--text); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.2rem;">üìÅ</span> Master Inventory Data
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
                            <div style="background: var(--bg-input); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; margin-bottom: 4px;">Price</div>
                                <div style="font-size: 1.1rem; font-weight: 600; color: var(--text);" id="masterPrice">$0.00</div>
                            </div>
                            <div style="background: var(--bg-input); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; margin-bottom: 4px;">Warehouse Qty</div>
                                <div style="font-size: 1.1rem; font-weight: 600; color: var(--text);" id="masterQty">0</div>
                            </div>
                            <div style="background: var(--bg-input); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; margin-bottom: 4px;">Etsy ID</div>
                                <div style="font-size: 0.9rem; font-weight: 500; color: var(--etsy);" id="masterEtsyId">Not Linked</div>
                            </div>
                            <div style="background: var(--bg-input); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; margin-bottom: 4px;">Wix ID</div>
                                <div style="font-size: 0.9rem; font-weight: 500; color: var(--wix);" id="masterWixId">Not Linked</div>
                            </div>
                            <div style="background: var(--bg-input); padding: 12px; border-radius: 8px;">
                                <div style="font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; margin-bottom: 4px;">Wayfair SKU</div>
                                <div style="font-size: 0.9rem; font-weight: 500; color: var(--wayfair);" id="masterWayfairSku">Not Linked</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="channel-grid">
                        <div class="channel-grid-header">Field</div>
                        <div class="channel-grid-header etsy">&#127978; Etsy <span class="channel-status" id="etsyListingStatus">Not Listed</span></div>
                        <div class="channel-grid-header wix">&#127760; Wix <span class="channel-status" id="wixListingStatus">Not Listed</span></div>
                        <div class="channel-grid-header wayfair">&#128722; Wayfair <span class="channel-status" id="wayfairListingStatus">Not Listed</span></div>
                        
                        <div class="field-label">Title</div>
                        <div class="field-cell" id="etsyTitle"><div class="field-value">-</div></div>
                        <div class="field-cell" id="wixTitle"><div class="field-value">-</div></div>
                        <div class="field-cell" id="wayfairTitle"><div class="field-value">-</div></div>
                        
                        <div class="field-label">Description</div>
                        <div class="field-cell" id="etsyDesc"><div class="field-value">-</div></div>
                        <div class="field-cell" id="wixDesc"><div class="field-value">-</div></div>
                        <div class="field-cell" id="wayfairDesc"><div class="field-value">-</div></div>
                        
                        <div class="field-label">Price</div>
                        <div class="field-cell" id="etsyPrice"><div class="field-value">-</div></div>
                        <div class="field-cell" id="wixPrice"><div class="field-value">-</div></div>
                        <div class="field-cell" id="wayfairPrice"><div class="field-value">-</div></div>
                        
                        <div class="field-label">Quantity</div>
                        <div class="field-cell" id="etsyQty"><div class="field-value">-</div></div>
                        <div class="field-cell" id="wixQty"><div class="field-value">-</div></div>
                        <div class="field-cell" id="wayfairQty"><div class="field-value">-</div></div>
                        
                        <div class="field-label">Status</div>
                        <div class="field-cell" id="etsyStatusCell"><div class="field-value">-</div></div>
                        <div class="field-cell" id="wixStatusCell"><div class="field-value">-</div></div>
                        <div class="field-cell" id="wayfairStatusCell"><div class="field-value">-</div></div>
                    </div>
                    
                    <h3 style="margin-bottom: 16px;">Quick Actions - Push to Channel</h3>
                    <div class="quick-actions">
                        <div class="quick-action-card etsy" onclick="pushToChannel('etsy')">
                            <div class="quick-action-icon">&#127978;</div>
                            <div class="quick-action-title">Push to Etsy</div>
                            <div class="quick-action-desc">Update or create listing on Etsy</div>
                        </div>
                        <div class="quick-action-card wix" onclick="pushToChannel('wix')">
                            <div class="quick-action-icon">&#127760;</div>
                            <div class="quick-action-title">Push to Wix</div>
                            <div class="quick-action-desc">Update or create product on Wix</div>
                        </div>
                        <div class="quick-action-card wayfair" onclick="pushToChannel('wayfair')">
                            <div class="quick-action-icon">&#128722;</div>
                            <div class="quick-action-title">Push to Wayfair</div>
                            <div class="quick-action-desc">Update or create product on Wayfair</div>
                        </div>
                    </div>
                    
                    <div class="sync-panel" id="syncPanel">
                        <div class="sync-panel-header">
                            <div class="sync-panel-title">&#128260; Manual Field Sync</div>
                            <button class="btn btn-sm btn-secondary" onclick="selectAllFields()">Select All</button>
                        </div>
                        <div class="sync-panel-body">
                            <div class="sync-row">
                                <div class="sync-field-name">Title</div>
                                <div class="sync-checkboxes">
                                    <label class="sync-checkbox"><input type="checkbox" id="syncTitleEtsy"><span class="sync-checkbox-label"><span class="dot etsy"></span> Etsy</span></label>
                                    <label class="sync-checkbox"><input type="checkbox" id="syncTitleWix"><span class="sync-checkbox-label"><span class="dot wix"></span> Wix</span></label>
                                    <label class="sync-checkbox"><input type="checkbox" id="syncTitleWayfair"><span class="sync-checkbox-label"><span class="dot wayfair"></span> Wayfair</span></label>
                                </div>
                            </div>
                            <div class="sync-row">
                                <div class="sync-field-name">Description</div>
                                <div class="sync-checkboxes">
                                    <label class="sync-checkbox"><input type="checkbox" id="syncDescEtsy"><span class="sync-checkbox-label"><span class="dot etsy"></span> Etsy</span></label>
                                    <label class="sync-checkbox"><input type="checkbox" id="syncDescWix"><span class="sync-checkbox-label"><span class="dot wix"></span> Wix</span></label>
                                    <label class="sync-checkbox"><input type="checkbox" id="syncDescWayfair"><span class="sync-checkbox-label"><span class="dot wayfair"></span> Wayfair</span></label>
                                </div>
                            </div>
                            <div class="sync-row">
                                <div class="sync-field-name">Price</div>
                                <div class="sync-checkboxes">
                                    <label class="sync-checkbox"><input type="checkbox" id="syncPriceEtsy"><span class="sync-checkbox-label"><span class="dot etsy"></span> Etsy</span></label>
                                    <label class="sync-checkbox"><input type="checkbox" id="syncPriceWix"><span class="sync-checkbox-label"><span class="dot wix"></span> Wix</span></label>
                                    <label class="sync-checkbox"><input type="checkbox" id="syncPriceWayfair"><span class="sync-checkbox-label"><span class="dot wayfair"></span> Wayfair</span></label>
                                </div>
                            </div>
                            <div class="sync-row">
                                <div class="sync-field-name">Quantity</div>
                                <div class="sync-checkboxes">
                                    <label class="sync-checkbox"><input type="checkbox" id="syncQtyEtsy"><span class="sync-checkbox-label"><span class="dot etsy"></span> Etsy</span></label>
                                    <label class="sync-checkbox"><input type="checkbox" id="syncQtyWix"><span class="sync-checkbox-label"><span class="dot wix"></span> Wix</span></label>
                                    <label class="sync-checkbox"><input type="checkbox" id="syncQtyWayfair"><span class="sync-checkbox-label"><span class="dot wayfair"></span> Wayfair</span></label>
                                </div>
                            </div>
                            <div class="sync-row">
                                <div class="sync-field-name">Images</div>
                                <div class="sync-checkboxes">
                                    <label class="sync-checkbox"><input type="checkbox" id="syncImagesEtsy"><span class="sync-checkbox-label"><span class="dot etsy"></span> Etsy</span></label>
                                    <label class="sync-checkbox"><input type="checkbox" id="syncImagesWix"><span class="sync-checkbox-label"><span class="dot wix"></span> Wix</span></label>
                                    <label class="sync-checkbox"><input type="checkbox" id="syncImagesWayfair"><span class="sync-checkbox-label"><span class="dot wayfair"></span> Wayfair</span></label>
                                </div>
                            </div>
                            <div class="sync-row">
                                <div class="sync-field-name">Variations</div>
                                <div class="sync-checkboxes">
                                    <label class="sync-checkbox"><input type="checkbox" id="syncVarEtsy"><span class="sync-checkbox-label"><span class="dot etsy"></span> Etsy</span></label>
                                    <label class="sync-checkbox"><input type="checkbox" id="syncVarWix"><span class="sync-checkbox-label"><span class="dot wix"></span> Wix</span></label>
                                    <label class="sync-checkbox"><input type="checkbox" id="syncVarWayfair"><span class="sync-checkbox-label"><span class="dot wayfair"></span> Wayfair</span></label>
                                </div>
                            </div>
                            <div class="sync-actions">
                                <select class="form-select" id="syncSource" style="width: 200px;">
                                    <option value="inventory">Source: Inventory</option>
                                    <option value="etsy">Source: Etsy</option>
                                    <option value="wix">Source: Wix</option>
                                    <option value="wayfair">Source: Wayfair</option>
                                </select>
                                <button class="btn btn-secondary" onclick="previewSync()">Preview</button>
                                <button class="btn btn-primary" onclick="executeSync()">&#128260; Execute Sync</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="syncView" class="view">
                <h2 style="margin-bottom: 20px;">Sync Queue</h2>
                <div class="sync-panel">
                    <div class="sync-panel-header">
                        <div class="sync-panel-title">Pending Operations</div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-sm btn-secondary" onclick="clearQueue()">Clear</button>
                            <button class="btn btn-sm btn-primary" onclick="processQueue()">Process All</button>
                        </div>
                    </div>
                    <div class="sync-panel-body" id="syncQueueList">
                        <div class="empty-state" style="padding: 40px;">
                            <div class="empty-state-icon">&#9989;</div>
                            <div class="empty-state-title">Queue Empty</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="settingsView" class="view">
                <h2 style="margin-bottom: 20px;">Channel Settings</h2>
                <div class="settings-section">
                    <div class="settings-header">
                        <div class="settings-icon wayfair">üõí</div>
                        <div>
                            <div style="font-weight: 600;">Wayfair</div>
                            <div style="font-size: 0.85rem; color: var(--text-dim);">Supplier API Integration</div>
                        </div>
                        <span class="env-badge sandbox" id="wayfairEnvBadgeSettings" style="margin-left: auto;">üß™ Sandbox</span>
                    </div>
                    <div class="settings-body">
                        <div class="form-group">
                            <label class="form-label">Wayfair Proxy URL</label>
                            <input type="text" class="form-input" id="wayfairProxyUrl" placeholder="https://script.google.com/macros/s/.../exec" style="font-family: 'JetBrains Mono', monospace; font-size: 0.85rem;">
                            <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 6px;">Google Apps Script deployment URL for Wayfair API proxy</div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">CCD API Key</label>
                                <input type="password" class="form-input" id="wayfairApiKey" value="ccd_VW5ORDOIcuh34shSTmbEwNjnrMVHTIdF" style="font-family: 'JetBrains Mono', monospace;">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Supplier ID</label>
                                <input type="text" class="form-input" id="wayfairSupplierId" value="254744">
                            </div>
                        </div>
                        <div class="connection-status">
                            <span class="status-dot disconnected" id="wayfairStatusDot"></span>
                            <span id="wayfairStatusText">Not connected</span>
                            <button class="btn btn-sm btn-wayfair" style="margin-left: auto;" onclick="testWayfair()">Test Connection</button>
                        </div>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-header">
                        <div class="settings-icon etsy">&#127978;</div>
                        <div><div style="font-weight: 600;">Etsy</div><div style="font-size: 0.8rem; color: var(--text-dim);">CountryCharmDecorUS</div></div>
                    </div>
                    <div class="settings-body">
                        <div class="form-group">
                            <label class="form-label">Proxy URL</label>
                            <input type="text" class="form-input" id="etsyProxyUrl" placeholder="https://script.google.com/...">
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">Shop ID</label><input type="text" class="form-input" id="etsyShopId" value="CountryCharmDecorUS"></div>
                            <div class="form-group"><label class="form-label">API Key</label><input type="password" class="form-input" id="etsyApiKey"></div>
                        </div>
                        <div class="connection-status">
                            <span class="status-dot disconnected" id="etsyStatusDot"></span>
                            <span id="etsyStatusText">Not connected</span>
                            <button class="btn btn-sm btn-etsy" style="margin-left: auto;" onclick="testEtsy()">Test</button>
                        </div>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-header">
                        <div class="settings-icon wix">&#127760;</div>
                        <div><div style="font-weight: 600;">Wix</div><div style="font-size: 0.8rem; color: var(--text-dim);">Google Apps Script Proxy</div></div>
                    </div>
                    <div class="settings-body">
                        <div class="form-group">
                            <label class="form-label">Wix Proxy URL</label>
                            <input type="text" class="form-input" id="wixProxyUrl" placeholder="https://script.google.com/...">
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">Site ID <span style="font-weight: normal; color: var(--text-muted);">(info only)</span></label><input type="text" class="form-input" id="wixSiteId" placeholder="Configured in proxy"></div>
                        </div>
                        <div class="connection-status">
                            <span class="status-dot disconnected" id="wixStatusDot"></span>
                            <span id="wixStatusText">Not connected</span>
                            <button class="btn btn-sm btn-wix" style="margin-left: auto;" onclick="testWix()">Test</button>
                        </div>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-header">
                        <div class="settings-icon" style="background: linear-gradient(135deg, #0078d4, #50e6ff);">üìÅ</div>
                        <div>
                            <div style="font-weight: 600;">OneDrive Image Storage</div>
                            <div style="font-size: 0.85rem; color: var(--text-dim);">Product images folder for multi-channel sync</div>
                        </div>
                    </div>
                    <div class="settings-body">
                        <div class="form-group">
                            <label class="form-label">Image Folder</label>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <button class="btn btn-secondary" onclick="setupOneDriveFolder()" style="flex-shrink: 0;">üìÇ Select Folder</button>
                                <div id="oneDriveStatus" style="flex: 1; font-size: 0.85rem; color: var(--text-dim);">
                                    Not configured
                                </div>
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 8px; line-height: 1.5;">
                                <strong>Image Naming Convention:</strong><br>
                                ‚Ä¢ Main image: <code style="background: var(--bg-input); padding: 2px 6px; border-radius: 4px;">SKU.jpg</code> (e.g., 90969.jpg)<br>
                                ‚Ä¢ Additional images: <code style="background: var(--bg-input); padding: 2px 6px; border-radius: 4px;">SKU-2.jpg</code>, <code style="background: var(--bg-input); padding: 2px 6px; border-radius: 4px;">SKU-3.jpg</code>, etc.<br>
                                ‚Ä¢ Supported formats: JPG, PNG (max 10 images per product)
                            </div>
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="resetSettings()">Reset</button>
                    <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                </div>
            </div>

            <!-- COMPARE & SYNC VIEW -->
            <div id="compareView" class="view">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>üîÑ Compare & Sync Channels</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="fetchChannelData()">üîÑ Refresh Channel Data</button>
                    </div>
                </div>
                
                <!-- Toolbar -->
                <div style="background: var(--bg-card); border-radius: 8px; padding: 16px; margin-bottom: 16px; display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span id="compareSelectedCount" style="background: var(--info); color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">0 selected</span>
                    </div>
                    <div style="height: 24px; width: 1px; background: var(--border);"></div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <label style="font-size: 0.85rem; color: var(--text-dim);">Sync:</label>
                        <select class="form-select" id="compareSyncSource" style="width: 120px;">
                            <option value="master">üì¶ Master</option>
                            <option value="etsy">üé® Etsy</option>
                            <option value="wix">üåê Wix</option>
                        </select>
                        <span style="font-size: 1.2rem;">‚Üí</span>
                        <select class="form-select" id="compareSyncTarget" style="width: 120px;">
                            <option value="wix">üåê Wix</option>
                            <option value="etsy">üé® Etsy</option>
                        </select>
                    </div>
                    <div style="height: 24px; width: 1px; background: var(--border);"></div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-sm btn-secondary" onclick="openCompareFieldSelector()">üìã Fields</button>
                        <button class="btn btn-sm btn-primary" onclick="previewCompareSync()">üëÅÔ∏è Preview</button>
                        <button class="btn btn-sm" style="background: var(--success); color: white;" onclick="executeCompareSync()">‚ö° Sync Selected</button>
                    </div>
                </div>
                
                <!-- Filter Tabs -->
                <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <button class="filter-btn active" data-compare-filter="all" onclick="setCompareFilter('all')">All</button>
                    <button class="filter-btn" data-compare-filter="differences" onclick="setCompareFilter('differences')">‚ö†Ô∏è Differences</button>
                    <button class="filter-btn" data-compare-filter="etsy-only" onclick="setCompareFilter('etsy-only')">Etsy Only</button>
                    <button class="filter-btn" data-compare-filter="wix-only" onclick="setCompareFilter('wix-only')">Wix Only</button>
                    <button class="filter-btn" data-compare-filter="missing" onclick="setCompareFilter('missing')">Missing in Channel</button>
                </div>
                
                <!-- Compare Table -->
                <div style="background: var(--bg-card); border-radius: 8px; overflow: hidden;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                        <thead>
                            <tr style="background: var(--bg-input);">
                                <th style="padding: 12px; text-align: left; width: 40px;">
                                    <input type="checkbox" id="compareSelectAll" onchange="toggleCompareSelectAll()">
                                </th>
                                <th style="padding: 12px; text-align: left;">SKU</th>
                                <th style="padding: 12px; text-align: left;">Product Name</th>
                                <th style="padding: 12px; text-align: center; color: var(--master);">üì¶ Master</th>
                                <th style="padding: 12px; text-align: center; color: var(--etsy);">üé® Etsy</th>
                                <th style="padding: 12px; text-align: center; color: var(--wix);">üåê Wix</th>
                                <th style="padding: 12px; text-align: center;">Status</th>
                                <th style="padding: 12px; text-align: center;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="compareTableBody">
                            <tr><td colspan="8" style="padding: 40px; text-align: center; color: var(--text-dim);">
                                Click "üîÑ Refresh Channel Data" to load comparison
                            </td></tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Product Detail Compare Panel -->
                <div id="compareDetailPanel" style="display: none; margin-top: 20px; background: var(--bg-card); border-radius: 8px; padding: 20px;">
                    <h3 id="compareDetailTitle" style="margin-bottom: 16px;">Product Details</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                        <!-- Master Column -->
                        <div style="border: 2px solid var(--master); border-radius: 8px; overflow: hidden;">
                            <div style="background: rgba(16, 185, 129, 0.1); padding: 10px 16px; font-weight: 600; color: var(--master);">üì¶ Master JSON</div>
                            <div style="padding: 16px;" id="compareDetailMaster"></div>
                        </div>
                        <!-- Etsy Column -->
                        <div style="border: 2px solid var(--etsy); border-radius: 8px; overflow: hidden;">
                            <div style="background: rgba(241, 173, 89, 0.1); padding: 10px 16px; font-weight: 600; color: var(--etsy);">üé® Etsy</div>
                            <div style="padding: 16px;" id="compareDetailEtsy"></div>
                        </div>
                        <!-- Wix Column -->
                        <div style="border: 2px solid var(--wix); border-radius: 8px; overflow: hidden;">
                            <div style="background: rgba(59, 130, 246, 0.1); padding: 10px 16px; font-weight: 600; color: var(--wix);">üåê Wix</div>
                            <div style="padding: 16px;" id="compareDetailWix"></div>
                        </div>
                    </div>
                    <div style="margin-top: 16px; display: flex; gap: 10px; justify-content: center;">
                        <button class="btn btn-sm" style="background: var(--master); color: white;" onclick="pushCompareProduct('etsy')">üì§ Master ‚Üí Etsy</button>
                        <button class="btn btn-sm" style="background: var(--master); color: white;" onclick="pushCompareProduct('wix')">üì§ Master ‚Üí Wix</button>
                        <button class="btn btn-sm btn-etsy" onclick="copyCompareProduct('etsy', 'wix')">Etsy ‚Üí Wix</button>
                        <button class="btn btn-sm btn-wix" onclick="copyCompareProduct('wix', 'etsy')">Wix ‚Üí Etsy</button>
                    </div>
                </div>
            </div>

            <!-- Unified Orders View (v2.2) -->
            <div id="ordersView" class="view">
                <div id="syncDataAlert" class="connection-alert" style="display: none; margin-bottom: 20px;">
                    <div class="connection-alert-icon">üìä</div>
                    <div class="connection-alert-text">
                        <strong>Connect Sync Data File</strong>
                        <span>Connect to ccd-sync-data.json to load orders from all channels.</span>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="connectSyncDataFile()">Connect File</button>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h2 style="font-size: 1.3rem; margin-bottom: 4px;">üõí All Orders</h2>
                        <div id="syncDataStatus" style="font-size: 0.85rem; color: var(--text-dim);">Not connected</div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" onclick="connectSyncDataFile()">üìÇ Connect File</button>
                        <button class="btn btn-primary" onclick="loadSyncDataFile()">üîÑ Refresh</button>
                    </div>
                </div>
                
                <!-- Order Stats -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                    <div style="background: var(--bg-card); padding: 16px; border-radius: 8px; text-align: center; border-top: 3px solid var(--text-dim);">
                        <div style="font-size: 1.8rem; font-weight: 700;" id="statAllOrders">0</div>
                        <div style="font-size: 0.8rem; color: var(--text-dim);">All Orders</div>
                    </div>
                    <div style="background: var(--bg-card); padding: 16px; border-radius: 8px; text-align: center; border-top: 3px solid var(--etsy);">
                        <div style="font-size: 1.8rem; font-weight: 700; color: var(--etsy);" id="statEtsyOrders">0</div>
                        <div style="font-size: 0.8rem; color: var(--text-dim);">Etsy</div>
                    </div>
                    <div style="background: var(--bg-card); padding: 16px; border-radius: 8px; text-align: center; border-top: 3px solid var(--wix);">
                        <div style="font-size: 1.8rem; font-weight: 700; color: var(--wix);" id="statWixOrders">0</div>
                        <div style="font-size: 0.8rem; color: var(--text-dim);">Wix</div>
                    </div>
                    <div style="background: var(--bg-card); padding: 16px; border-radius: 8px; text-align: center; border-top: 3px solid var(--wayfair);">
                        <div style="font-size: 1.8rem; font-weight: 700; color: var(--wayfair);" id="statWayfairOrders">0</div>
                        <div style="font-size: 0.8rem; color: var(--text-dim);">Wayfair</div>
                    </div>
                </div>
                
                <!-- Channel Filter -->
                <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <button class="filter-btn active" data-channel="all" onclick="filterOrders('all')">All</button>
                    <button class="filter-btn" data-channel="etsy" onclick="filterOrders('etsy')" style="border-color: var(--etsy);">üõí Etsy</button>
                    <button class="filter-btn" data-channel="wix" onclick="filterOrders('wix')" style="border-color: var(--wix);">üåê Wix</button>
                    <button class="filter-btn" data-channel="wayfair" onclick="filterOrders('wayfair')" style="border-color: var(--wayfair);">üè† Wayfair</button>
                </div>
                
                <!-- Orders List -->
                <div id="allOrdersList">
                    <div class="empty-state" style="padding: 60px;">
                        <div class="empty-state-icon">üìã</div>
                        <div class="empty-state-title">No orders loaded</div>
                        <div style="color: var(--text-dim);">Connect to ccd-sync-data.json to load orders from all channels</div>
                    </div>
                </div>
            </div>
            
            <!-- Legacy Wayfair Orders View (kept for compatibility) -->
            <div id="wayfairOrdersView" class="view" style="display: none;">
                <!-- Redirects to unified orders view -->
            </div>
        </div>
    </main>
    
    <div class="modal-overlay" id="pushModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="pushModalTitle">Push to Channel</h2>
                <button class="modal-close" onclick="closeModal('pushModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Select fields to push:</label>
                    <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 12px;">
                        <label class="sync-checkbox"><input type="checkbox" id="pushTitle" checked> Title</label>
                        <label class="sync-checkbox"><input type="checkbox" id="pushDesc" checked> Description</label>
                        <label class="sync-checkbox"><input type="checkbox" id="pushPrice" checked> Price</label>
                        <label class="sync-checkbox"><input type="checkbox" id="pushQty" checked> Quantity</label>
                        <label class="sync-checkbox"><input type="checkbox" id="pushImages"> Images</label>
                        <label class="sync-checkbox"><input type="checkbox" id="pushVar"> Variations</label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Action</label>
                    <select class="form-select" id="pushAction">
                        <option value="update">Update existing</option>
                        <option value="create">Create new</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('pushModal')">Cancel</button>
                <button class="btn btn-primary" id="pushBtn" onclick="executePush()">Push</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="createModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Create Listing</h2>
                <button class="modal-close" onclick="closeModal('createModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Source</label>
                    <select class="form-select" id="createSource" onchange="loadSourceProducts()">
                        <option value="">Select...</option>
                        <option value="inventory">Inventory</option>
                        <option value="etsy">Etsy</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Product</label>
                    <select class="form-select" id="createProduct"><option value="">Select product...</option></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Create On:</label>
                    <div style="display: flex; gap: 20px; margin-top: 8px;">
                        <label class="sync-checkbox"><input type="checkbox" id="createEtsy"><span class="sync-checkbox-label"><span class="dot etsy"></span> Etsy</span></label>
                        <label class="sync-checkbox"><input type="checkbox" id="createWix"><span class="sync-checkbox-label"><span class="dot wix"></span> Wix</span></label>
                        <label class="sync-checkbox"><input type="checkbox" id="createWayfair"><span class="sync-checkbox-label"><span class="dot wayfair"></span> Wayfair</span></label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createListing()">Create</button>
            </div>
        </div>
    </div>

    <!-- PRODUCT EDITOR MODAL - Full featured product editing -->
    <div class="modal-overlay" id="productEditorModal">
        <div class="modal" style="max-width: 900px; width: 95%;">
            <div class="modal-header">
                <h2 class="modal-title" id="editorModalTitle">üìù Edit Product</h2>
                <button class="modal-close" onclick="closeModal('productEditorModal')">√ó</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <!-- Basic Info Section -->
                <div style="background: var(--bg-input); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <h3 style="margin: 0 0 12px 0; font-size: 1rem; color: var(--text);">üì¶ Basic Information</h3>
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">SKU <span style="color: var(--danger);">*</span></label>
                            <input type="text" class="form-input" id="editorSku" placeholder="e.g., 90969">
                        </div>
                        <div class="form-group" style="flex: 2;">
                            <label class="form-label">Product Name <span style="color: var(--danger);">*</span></label>
                            <input type="text" class="form-input" id="editorName" placeholder="e.g., Paisley Bird Rain Gauge">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-input" id="editorDescription" rows="4" placeholder="Full product description..."></textarea>
                    </div>
                </div>

                <!-- Pricing & Inventory Section -->
                <div style="background: var(--bg-input); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <h3 style="margin: 0 0 12px 0; font-size: 1rem; color: var(--text);">üí∞ Pricing & Inventory</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Retail Price</label>
                            <input type="number" class="form-input" id="editorPrice" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cost Price</label>
                            <input type="number" class="form-input" id="editorCost" step="0.01" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Warehouse Qty</label>
                            <input type="number" class="form-input" id="editorQty" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Weight (oz)</label>
                            <input type="number" class="form-input" id="editorWeight" step="0.1" placeholder="0.0">
                        </div>
                    </div>
                </div>

                <!-- Dimensions Section -->
                <div style="background: var(--bg-input); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <h3 style="margin: 0 0 12px 0; font-size: 1rem; color: var(--text);">üìê Dimensions (inches)</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Length</label>
                            <input type="number" class="form-input" id="editorLength" step="0.1" placeholder="0.0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Width</label>
                            <input type="number" class="form-input" id="editorWidth" step="0.1" placeholder="0.0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Height</label>
                            <input type="number" class="form-input" id="editorHeight" step="0.1" placeholder="0.0">
                        </div>
                    </div>
                </div>

                <!-- Channel Links Section -->
                <div style="background: var(--bg-input); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <h3 style="margin: 0 0 12px 0; font-size: 1rem; color: var(--text);">üîó Channel Links</h3>
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label" style="color: var(--etsy);">üè† Etsy Listing ID</label>
                            <input type="text" class="form-input" id="editorEtsyId" placeholder="e.g., 1207696083">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label" style="color: var(--wix);">üåê Wix Product ID</label>
                            <input type="text" class="form-input" id="editorWixId" placeholder="e.g., abc123-def456">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label" style="color: var(--wayfair);">üõí Wayfair SKU</label>
                            <input type="text" class="form-input" id="editorWayfairSku" placeholder="e.g., CCD90969">
                        </div>
                    </div>
                </div>

                <!-- Images Section -->
                <div style="background: var(--bg-input); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <h3 style="margin: 0 0 12px 0; font-size: 1rem; color: var(--text);">üñºÔ∏è Images</h3>
                    <div class="form-group">
                        <label class="form-label">Image URLs (one per line)</label>
                        <textarea class="form-input" id="editorImages" rows="3" placeholder="https://example.com/image1.jpg&#10;https://example.com/image2.jpg"></textarea>
                    </div>
                    <div id="editorImagePreview" style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;"></div>
                </div>

                <!-- Additional Fields Section -->
                <div style="background: var(--bg-input); padding: 16px; border-radius: 8px;">
                    <h3 style="margin: 0 0 12px 0; font-size: 1rem; color: var(--text);">üìã Additional Fields</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <input type="text" class="form-input" id="editorCategory" placeholder="e.g., Home & Garden">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tags (comma separated)</label>
                            <input type="text" class="form-input" id="editorTags" placeholder="e.g., rain gauge, garden, bird">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">UPC/Barcode</label>
                            <input type="text" class="form-input" id="editorUpc" placeholder="e.g., 123456789012">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Vendor/Supplier</label>
                            <input type="text" class="form-input" id="editorVendor" placeholder="e.g., Acme Corp">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: space-between;">
                <div>
                    <button class="btn btn-danger" id="editorDeleteBtn" onclick="deleteProductFromEditor()" style="display: none;">üóëÔ∏è Delete</button>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" onclick="closeModal('productEditorModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="saveProductFromEditor()">üíæ Save to Master JSON</button>
                </div>
            </div>
        </div>
    </div>

    <!-- COMPARE FIELD SELECTOR MODAL -->
    <div class="modal-overlay" id="compareFieldModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title">üìã Select Fields to Sync</h2>
                <button class="modal-close" onclick="closeModal('compareFieldModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg-input); border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" id="compareFieldTitle" checked> Title / Name
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg-input); border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" id="compareFieldDescription"> Description
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg-input); border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" id="compareFieldPrice" checked> Price
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg-input); border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" id="compareFieldQuantity" checked> Quantity
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg-input); border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" id="compareFieldImages"> Images
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg-input); border-radius: 6px; cursor: pointer;">
                        <input type="checkbox" id="compareFieldSku"> SKU
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('compareFieldModal')">Cancel</button>
                <button class="btn btn-primary" onclick="closeModal('compareFieldModal')">Apply</button>
            </div>
        </div>
    </div>

    <!-- COMPARE SYNC PREVIEW MODAL -->
    <div class="modal-overlay" id="compareSyncPreviewModal">
        <div class="modal" style="max-width: 800px; width: 95%;">
            <div class="modal-header">
                <h2 class="modal-title">üîç Sync Preview</h2>
                <button class="modal-close" onclick="closeModal('compareSyncPreviewModal')">√ó</button>
            </div>
            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;" id="compareSyncPreviewContent">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('compareSyncPreviewModal')">Cancel</button>
                <button class="btn btn-success" onclick="confirmCompareSync()">‚úÖ Confirm & Sync</button>
            </div>
        </div>
    </div>

    <!-- COMPARE SYNC PROGRESS MODAL -->
    <div class="modal-overlay" id="compareSyncProgressModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">‚è≥ Syncing...</h2>
            </div>
            <div class="modal-body">
                <div id="compareSyncProgressText" style="margin-bottom: 12px;">Processing...</div>
                <div style="width: 100%; height: 8px; background: var(--bg-input); border-radius: 4px; overflow: hidden;">
                    <div id="compareSyncProgressBar" style="height: 100%; background: var(--success); width: 0%; transition: width 0.3s;"></div>
                </div>
                <div id="compareSyncProgressDetails" style="font-size: 0.85rem; color: var(--text-dim); margin-top: 12px;"></div>
            </div>
        </div>
    </div>

    <!-- IMPORT PREVIEW MODAL -->
    <div class="modal-overlay" id="importPreviewModal">
        <div class="modal" style="max-width: 900px; width: 95%;">
            <div class="modal-header">
                <h2 class="modal-title" id="importModalTitle">üì• Import Preview</h2>
                <button class="modal-close" onclick="closeModal('importPreviewModal')">√ó</button>
            </div>
            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                <div id="importSummary" style="background: var(--bg-input); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; text-align: center;">
                        <div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--info);" id="importTotalCount">0</div>
                            <div style="font-size: 0.8rem; color: var(--text-dim);">Total in Channel</div>
                        </div>
                        <div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);" id="importMatchedCount">0</div>
                            <div style="font-size: 0.8rem; color: var(--text-dim);">Will Link (SKU Match)</div>
                        </div>
                        <div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);" id="importNewCount">0</div>
                            <div style="font-size: 0.8rem; color: var(--text-dim);">New Products</div>
                        </div>
                        <div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-dim);" id="importAlreadyLinkedCount">0</div>
                            <div style="font-size: 0.8rem; color: var(--text-dim);">Already Linked</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 12px;">
                    <label class="sync-checkbox">
                        <input type="checkbox" id="importCreateNew" checked>
                        <span class="sync-checkbox-label">Create new products in Master JSON for unmatched items</span>
                    </label>
                </div>
                
                <div id="importPreviewList" style="border: 1px solid var(--border); border-radius: 8px; overflow: hidden;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                        <thead>
                            <tr style="background: var(--bg-input);">
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid var(--border);">
                                    <label class="sync-checkbox" style="margin: 0;">
                                        <input type="checkbox" id="importSelectAll" checked onchange="toggleAllImports()">
                                    </label>
                                </th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid var(--border);">SKU</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid var(--border);">Product Name</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid var(--border);">Channel ID</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid var(--border);">Action</th>
                            </tr>
                        </thead>
                        <tbody id="importPreviewBody">
                            <tr><td colspan="5" style="padding: 20px; text-align: center; color: var(--text-dim);">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('importPreviewModal')">Cancel</button>
                <button class="btn btn-primary" id="executeImportBtn" onclick="executeImport()">üì• Import Selected</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="acceptOrderModal">
        <div class="modal lg">
            <div class="modal-header">
                <h2 class="modal-title">‚úÖ Accept Order <span id="acceptOrderPO" style="color: var(--wayfair);"></span></h2>
                <button class="modal-close" onclick="closeModal('acceptOrderModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div id="acceptOrderItems"></div>
                <div class="form-group" style="margin-top: 20px;">
                    <label class="form-label">Estimated Ship Date</label>
                    <input type="date" class="form-input" id="acceptShipDate">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('acceptOrderModal')">Cancel</button>
                <button class="btn btn-primary" style="background: var(--success);" onclick="confirmAcceptOrder()">‚úÖ Accept Order</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="shipOrderModal">
        <div class="modal lg">
            <div class="modal-header">
                <h2 class="modal-title">üì¶ Ship Order <span id="shipOrderPO" style="color: var(--wayfair);"></span></h2>
                <button class="modal-close" onclick="closeModal('shipOrderModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Carrier</label>
                        <select class="form-select" id="shipCarrierCode">
                            <option value="UPSN">UPS</option>
                            <option value="FDEG">FedEx</option>
                            <option value="USPS">USPS</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ship Speed</label>
                        <select class="form-select" id="shipSpeed">
                            <option value="GROUND">Ground</option>
                            <option value="EXPEDITED">Expedited</option>
                            <option value="NEXT_DAY">Next Day</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Tracking Number</label>
                    <input type="text" class="form-input" id="shipTrackingNumber" placeholder="1Z999AA10123456784" style="font-family: 'JetBrains Mono', monospace;">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Ship Date</label>
                        <input type="date" class="form-input" id="shipDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Package Count</label>
                        <input type="number" class="form-input" id="shipPackageCount" value="1" min="1">
                    </div>
                </div>
                <div id="shipOrderItems"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('shipOrderModal')">Cancel</button>
                <button class="btn btn-primary" onclick="confirmShipOrder()">üì¶ Send ASN</button>
            </div>
        </div>
    </div>

    <!-- MULTI-CHANNEL PUSH MODAL -->
    <div class="modal-overlay" id="multiChannelPushModal">
        <div class="modal lg">
            <div class="modal-header">
                <h2 class="modal-title">üöÄ Push to Multiple Channels</h2>
                <button class="modal-close" onclick="closeModal('multiChannelPushModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px; padding: 12px; background: var(--bg-input); border-radius: 8px;">
                    <strong id="multiPushProductName">Product Name</strong>
                    <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: var(--text-dim); margin-top: 4px;">
                        SKU: <span id="multiPushProductSKU">12345</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Select Channels to Push To:</label>
                    <div class="channel-checkboxes">
                        <label class="channel-checkbox-item">
                            <input type="checkbox" id="multiPushEtsy">
                            <span class="channel-checkbox-label">
                                <span style="font-size: 1.2rem;">üé®</span>
                                <span style="flex: 1;">Etsy</span>
                                <span class="channel-checkbox-status" id="multiPushEtsyStatus">Not Listed</span>
                            </span>
                        </label>
                        <label class="channel-checkbox-item">
                            <input type="checkbox" id="multiPushWix">
                            <span class="channel-checkbox-label">
                                <span style="font-size: 1.2rem;">üåê</span>
                                <span style="flex: 1;">Wix</span>
                                <span class="channel-checkbox-status" id="multiPushWixStatus">Not Listed</span>
                            </span>
                        </label>
                        <label class="channel-checkbox-item">
                            <input type="checkbox" id="multiPushWayfair">
                            <span class="channel-checkbox-label">
                                <span style="font-size: 1.2rem;">üè†</span>
                                <span style="flex: 1;">Wayfair</span>
                                <span class="channel-checkbox-status" id="multiPushWayfairStatus">Not Listed</span>
                            </span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Fields to Sync:</label>
                    <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 12px;">
                        <label class="sync-checkbox"><input type="checkbox" id="multiPushTitle" checked> Title</label>
                        <label class="sync-checkbox"><input type="checkbox" id="multiPushDesc" checked> Description</label>
                        <label class="sync-checkbox"><input type="checkbox" id="multiPushPrice" checked> Price</label>
                        <label class="sync-checkbox"><input type="checkbox" id="multiPushQty" checked> Quantity</label>
                        <label class="sync-checkbox"><input type="checkbox" id="multiPushImages" checked> Images (from OneDrive)</label>
                        <label class="sync-checkbox"><input type="checkbox" id="multiPushVar"> Variations</label>
                    </div>
                </div>
                
                <div id="imagePreviewSection" class="image-preview-section" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <strong>Images Found:</strong>
                        <span class="image-count" id="imageCount">0 images</span>
                    </div>
                    <div class="image-preview-grid" id="imagePreviewGrid"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Action:</label>
                    <select class="form-select" id="multiPushAction">
                        <option value="update">Update existing listings</option>
                        <option value="create">Create new listings</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('multiChannelPushModal')">Cancel</button>
                <button class="btn btn-primary" onclick="executeMultiChannelPush()">üöÄ Push to Selected Channels</button>
            </div>
        </div>
    </div>
    
    <div class="toast-container" id="toastContainer"></div>

    <script>
    const state = {
        products: [], selectedProduct: null, filter: 'all', syncQueue: [], pushTarget: null,
        // Orders from all channels (loaded from sync data file)
        orders: {
            etsy: [],
            wix: [],
            wayfair: [],
            all: []
        },
        currentOrder: null,
        settings: { 
            etsyProxyUrl: '', etsyShopId: 'CountryCharmDecorUS', etsyApiKey: '', 
            wixProxyUrl: '', wixSiteId: '',
            wayfairProxyUrl: '', wayfairApiKey: 'ccd_VW5ORDOIcuh34shSTmbEwNjnrMVHTIdF', 
            wayfairSupplierId: '254744', wayfairEnvironment: 'sandbox'
        },
        connections: { etsy: false, wix: false, wayfair: false }
    };
    
    // Sync data file handle (v2.2)
    let syncDataFileHandle = null;
    let syncDataCache = null;
    
    // Legacy compatibility
    Object.defineProperty(state, 'wayfairOrders', {
        get: function() { return state.orders.wayfair; },
        set: function(val) { state.orders.wayfair = val; }
    });
    
    // ===== SYNC HUB INTEGRATION =====
    // Save queue to localStorage so Sync Hub can process it
    function saveSyncQueue() {
        localStorage.setItem('ccd_sync_hub_queue', JSON.stringify(state.syncQueue));
    }
    
    function loadSyncQueue() {
        const saved = localStorage.getItem('ccd_sync_hub_queue');
        if (saved) {
            try {
                state.syncQueue = JSON.parse(saved);
            } catch (e) {
                console.error('Error loading sync queue:', e);
            }
        }
    }
    // ===== END SYNC HUB INTEGRATION =====
    
    // =============================================
    // ACTIVITY LOG INTEGRATION (v2.2)
    // Centralized logging for all channel manager events
    // Entries stored in _activityLog array in Master JSON
    // View with CCD-ACTIVITY-LOG.html module
    // =============================================
    
    // Reference to master data for activity logging
    let masterJsonData = null;
    
    /**
     * Log an activity entry to the Master JSON _activityLog array
     * @param {string} category - order|sync|inventory|payment|system|error
     * @param {string} action - Specific action (e.g., push_success, import_complete)
     * @param {string} channel - wayfair|etsy|wix|system
     * @param {string} summary - Human-readable description
     * @param {object} details - Structured data (sku, quantities, etc.)
     */
    function logActivity(category, action, channel, summary, details = {}) {
        // Only log if we have master data loaded
        if (!masterJsonData) {
            console.log(`üìã [Activity] ${category}/${action}: ${summary} (not saved - no master file)`);
            return null;
        }
        
        // Initialize _activityLog if it doesn't exist
        if (!masterJsonData._activityLog) {
            masterJsonData._activityLog = [];
        }
        
        const entry = {
            id: `act_${Date.now()}_${Math.random().toString(36).substr(2, 4)}`,
            timestamp: new Date().toISOString(),
            category: category,
            action: action,
            channel: channel,
            summary: summary,
            details: details,
            device: localStorage.getItem('ccd_hostname') || 'ChannelManager',
            user: localStorage.getItem('ccdUsername') || 'Unknown'
        };
        
        // Add to beginning of array (newest first)
        masterJsonData._activityLog.unshift(entry);
        
        // Keep log at reasonable size (last 5000 entries)
        if (masterJsonData._activityLog.length > 5000) {
            masterJsonData._activityLog = masterJsonData._activityLog.slice(0, 5000);
        }
        
        console.log(`üìã [Activity] ${category}/${action}: ${summary}`);
        
        return entry;
    }
    
    // =============================================
    // END ACTIVITY LOG INTEGRATION
    // =============================================
    
    document.addEventListener('DOMContentLoaded', async () => { 
        // COLLISION DETECTION: Ensure hostname is set for tracking
        ensureHostnameSet();
        
        await initDB(); 
        loadSettings(); 
        
        // Try to reconnect to master file first
        const reconnected = await tryReconnectMasterFile();
        
        // Try to reconnect to OneDrive folder
        await tryReconnectOneDriveFolder();
        
        // Try to reconnect to sync data file (v2.2)
        await tryReconnectSyncDataFile();
        
        // If no file reconnected, try localStorage
        if (!reconnected) {
            loadProducts();
        }
        
        testEtsy(true); 
        testWix(true);
        testWayfair(true); 
        updateOneDriveStatus(); 
        refreshDashboard(); 
        loadSyncQueue();
        updateFileStatus();
        
        console.log('[Init] CCD Channel Manager v2.2 initialized');
        
        // Log startup to Activity Log (only if Master JSON is connected)
        setTimeout(() => {
            if (typeof logActivity === 'function' && masterJsonData) {
                logActivity('system', 'channel_manager_started', 'system',
                    'Channel Manager v2.2 started',
                    { reconnected: reconnected, syncDataConnected: !!syncDataFileHandle }
                );
            }
        }, 2000);
    });
    
    function switchView(v) {
        document.querySelectorAll('.view').forEach(x => x.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(x => x.classList.remove('active'));
        const view = document.getElementById(v + 'View');
        if (view) view.classList.add('active');
        const btn = document.querySelector(`.nav-btn[data-view="${v}"]`);
        if (btn) btn.classList.add('active');
        
        // Legacy redirect: wayfairOrders -> orders
        if (v === 'wayfairOrders') {
            switchView('orders');
            return;
        }
        
        if (v === 'orders' && !syncDataFileHandle) {
            document.getElementById('syncDataAlert').style.display = 'flex';
        }
        if (v === 'dashboard') refreshDashboard();
    }
    
    // ============================================================
    // MASTER FILE CONNECTION (File System Access API)
    // ============================================================
    
    let masterFileHandle = null;
    
    // ============================================================
    // COLLISION DETECTION - Tracking variables
    // ============================================================
    let loadedFileTimestamp = null;     // File's lastModified when loaded
    let loadedMetadataVersion = null;   // _metadata.version when loaded
    
    // ============================================================
    // COLLISION DETECTION FUNCTIONS
    // ============================================================
    
    /**
     * One-time PC name setup for identifying which computer made changes
     */
    function ensureHostnameSet() {
        if (!localStorage.getItem('ccd_hostname')) {
            const name = prompt(
                'Enter a name for this computer (e.g., "Paul PC", "Mary Laptop"):\n\n' +
                'This helps identify which computer made changes to the inventory.',
                'My Computer'
            );
            if (name) {
                localStorage.setItem('ccd_hostname', name.trim());
            }
        }
    }
    
    /**
     * Get app identifier for metadata tracking
     */
    function getAppIdentifier() {
        const appName = 'Channel Manager';
        const hostname = localStorage.getItem('ccd_hostname') || 'Unknown PC';
        return `${appName} (${hostname})`;
    }
    
    /**
     * Check if the master file has been modified since we loaded it
     */
    async function checkForCollision() {
        if (!masterFileHandle) return { collision: false };
        
        try {
            const file = await masterFileHandle.getFile();
            const currentTimestamp = file.lastModified;
            
            // Primary check: file timestamp changed
            if (loadedFileTimestamp && currentTimestamp !== loadedFileTimestamp) {
                // Read current metadata to show who changed it
                const content = await file.text();
                const currentData = JSON.parse(content);
                const meta = currentData._metadata || {};
                
                return {
                    collision: true,
                    ourVersion: loadedMetadataVersion || 0,
                    currentVersion: meta.version || 0,
                    lastModifiedBy: meta.lastModifiedBy || 'Unknown',
                    lastAction: meta.lastAction || 'Unknown action',
                    lastModified: meta.lastModified || 'Unknown time'
                };
            }
            
            return { collision: false };
            
        } catch (error) {
            console.error('Collision check error:', error);
            return { collision: false }; // Fail open - allow save
        }
    }
    
    /**
     * Show collision dialog and return user's choice
     */
    function showCollisionDialog(collisionInfo) {
        return new Promise((resolve) => {
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.id = 'collision-modal-overlay';
            overlay.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5); z-index: 10000;
                display: flex; align-items: center; justify-content: center;
            `;
            
            const modifiedTime = collisionInfo.lastModified !== 'Unknown time' 
                ? new Date(collisionInfo.lastModified).toLocaleString()
                : 'Unknown time';
            
            overlay.innerHTML = `
                <div style="background: var(--bg-card, #141d2f); border-radius: 12px; padding: 24px; max-width: 450px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); border: 1px solid var(--border, #2a3f5f);">
                    <h2 style="margin: 0 0 16px 0; color: #ef4444; display: flex; align-items: center; gap: 10px; font-size: 1.2rem;">
                        ‚ö†Ô∏è File Modified by Another User
                    </h2>
                    <p style="margin: 0 0 12px 0; color: var(--text, #e2e8f0);">
                        The inventory file has been modified since you loaded it.
                    </p>
                    <div style="background: var(--bg-input, #1a2540); padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; color: var(--text, #e2e8f0);">
                        <div><strong>Modified by:</strong> ${collisionInfo.lastModifiedBy}</div>
                        <div><strong>Action:</strong> ${collisionInfo.lastAction}</div>
                        <div><strong>Time:</strong> ${modifiedTime}</div>
                    </div>
                    <p style="margin: 0 0 16px 0; color: var(--text-dim, #8892a6); font-size: 14px;">
                        What would you like to do?
                    </p>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button id="collision-reload" style="flex: 1; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            üîÑ Reload File
                        </button>
                        <button id="collision-overwrite" style="flex: 1; padding: 12px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            ‚ö†Ô∏è Overwrite Anyway
                        </button>
                    </div>
                    <button id="collision-cancel" style="width: 100%; margin-top: 12px; padding: 10px; background: var(--bg-hover, #1e2d4a); color: var(--text, #e2e8f0); border: 1px solid var(--border, #2a3f5f); border-radius: 8px; cursor: pointer;">
                        Cancel
                    </button>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            document.getElementById('collision-reload').onclick = () => {
                document.body.removeChild(overlay);
                resolve('reload');
            };
            
            document.getElementById('collision-overwrite').onclick = () => {
                document.body.removeChild(overlay);
                resolve('overwrite');
            };
            
            document.getElementById('collision-cancel').onclick = () => {
                document.body.removeChild(overlay);
                resolve('cancel');
            };
        });
    }
    
    /**
     * Prune change log to keep only last 500 entries and max 30 days
     */
    function pruneChangeLog(data) {
        if (!data._changeLog) return;
        
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        
        // Remove entries older than 30 days
        data._changeLog = data._changeLog.filter(entry => 
            new Date(entry.timestamp) > thirtyDaysAgo
        );
        
        // Keep max 500 entries
        if (data._changeLog.length > 500) {
            data._changeLog = data._changeLog.slice(0, 500);
        }
    }
    
    /**
     * Create a change log entry
     */
    function createChangeLogEntry(changeData) {
        return {
            id: `chg-${Date.now()}-${Math.random().toString(36).substr(2, 6)}`,
            timestamp: new Date().toISOString(),
            source: getAppIdentifier(),
            changeType: changeData.changeType || 'manual',
            sku: changeData.sku || '',
            field: changeData.field || '',
            before: changeData.before,
            after: changeData.after,
            reason: changeData.reason || '',
            user: changeData.user || localStorage.getItem('ccd_hostname') || 'Unknown'
        };
    }
    
    // IndexedDB for file handle persistence
    const DB_NAME = 'ccd_channel_manager_db';
    const STORE_NAME = 'file_handles';
    let db = null;
    
    async function initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, 1);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
                db = request.result;
                resolve(db);
            };
            request.onupgradeneeded = (event) => {
                const database = event.target.result;
                if (!database.objectStoreNames.contains(STORE_NAME)) {
                    database.createObjectStore(STORE_NAME);
                }
            };
        });
    }
    
    async function saveMasterFileHandle(handle) {
        if (!db) await initDB();
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.put(handle, 'masterFile');
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    }
    
    async function saveOneDriveFolderHandle(handle) {
        if (!db) await initDB();
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.put(handle, 'oneDriveFolder');
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    }
    
    async function loadMasterFileHandle() {
        if (!db) await initDB();
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.get('masterFile');
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }
    
    async function loadOneDriveFolderHandle() {
        if (!db) await initDB();
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.get('oneDriveFolder');
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }
    
    // ============================================================
    // SYNC DATA FILE FUNCTIONS (v2.2)
    // Read orders from ccd-sync-data.json instead of API calls
    // ============================================================
    
    async function saveSyncDataFileHandle(handle) {
        if (!db) await initDB();
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.put(handle, 'syncDataFile');
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    }
    
    async function loadSyncDataFileHandle() {
        if (!db) await initDB();
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.get('syncDataFile');
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }
    
    async function connectSyncDataFile() {
        try {
            const [handle] = await window.showOpenFilePicker({
                types: [{
                    description: 'Sync Data JSON',
                    accept: { 'application/json': ['.json'] }
                }],
                multiple: false
            });
            
            const permission = await handle.requestPermission({ mode: 'read' });
            if (permission !== 'granted') {
                toast('‚ùå Permission denied', 'error');
                return false;
            }
            
            syncDataFileHandle = handle;
            await saveSyncDataFileHandle(handle);
            await loadSyncDataFile();
            
            updateSyncDataStatus(true, handle.name);
            toast('‚úÖ Connected to ' + handle.name, 'success');
            return true;
        } catch (e) {
            if (e.name !== 'AbortError') {
                toast('‚ùå Failed to connect: ' + e.message, 'error');
            }
            return false;
        }
    }
    
    async function loadSyncDataFile() {
        if (!syncDataFileHandle) return false;
        
        try {
            const file = await syncDataFileHandle.getFile();
            const data = JSON.parse(await file.text());
            
            syncDataCache = data;
            
            // Load orders from each channel
            state.orders.etsy = data.etsy?.orders || [];
            state.orders.wix = data.wix?.orders || [];
            state.orders.wayfair = data.wayfair?.orders || [];
            
            // Combine all orders
            state.orders.all = [
                ...state.orders.etsy.map(o => ({ ...o, channel: 'etsy' })),
                ...state.orders.wix.map(o => ({ ...o, channel: 'wix' })),
                ...state.orders.wayfair.map(o => ({ ...o, channel: 'wayfair' }))
            ].sort((a, b) => new Date(b.date || b.orderDate) - new Date(a.date || a.orderDate));
            
            console.log(`[Sync Data] Loaded: Etsy(${state.orders.etsy.length}), Wix(${state.orders.wix.length}), Wayfair(${state.orders.wayfair.length})`);
            
            // Update UI
            renderAllOrders();
            updateOrderStats();
            
            return true;
        } catch (e) {
            console.error('[Sync Data] Load error:', e);
            return false;
        }
    }
    
    async function tryReconnectSyncDataFile() {
        try {
            // v2.3: Check Command Center shared files first
            if (typeof CCDSharedFiles !== 'undefined') {
                const sharedHandle = await CCDSharedFiles.getSyncData();
                if (sharedHandle) {
                    syncDataFileHandle = sharedHandle;
                    await loadSyncDataFile();
                    updateSyncDataStatus(true, 'Shared via Command Center');
                    console.log('[Sync Data] Connected via Command Center shared files');
                    return true;
                }
            }
            
            // Fall back to own stored handle
            const handle = await loadSyncDataFileHandle();
            if (!handle) return false;
            
            const permission = await handle.queryPermission({ mode: 'read' });
            if (permission === 'granted') {
                syncDataFileHandle = handle;
                await loadSyncDataFile();
                updateSyncDataStatus(true, handle.name);
                console.log('[Sync Data] Auto-reconnected');
                return true;
            }
        } catch (e) {
            console.log('[Sync Data] Auto-reconnect failed:', e.message);
        }
        return false;
    }
    
    function updateSyncDataStatus(connected, fileName = '') {
        const statusEl = document.getElementById('syncDataStatus');
        if (statusEl) {
            statusEl.innerHTML = connected 
                ? `<span style="color: var(--success);">‚úÖ ${fileName}</span>`
                : '<span style="color: var(--text-muted);">Not connected</span>';
        }
    }
    
    async function connectMasterFile() {
        try {
            const [handle] = await window.showOpenFilePicker({
                types: [{
                    description: 'CCD Master JSON',
                    accept: { 'application/json': ['.json'] }
                }],
                multiple: false
            });
            
            // Request permission
            const permission = await handle.requestPermission({ mode: 'read' });
            if (permission !== 'granted') {
                toast('‚ùå Permission denied', 'error');
                return;
            }
            
            masterFileHandle = handle;
            
            // Save to IndexedDB for persistence
            await saveMasterFileHandle(handle);
            localStorage.setItem('masterFileName', handle.name);
            
            // Load products from file
            await loadFromMasterFile();
            
            updateFileStatus();
            toast('‚úÖ Connected to ' + handle.name, 'success');
            
        } catch (error) {
            if (error.name !== 'AbortError') {
                console.error('File connection error:', error);
                toast('‚ùå Failed to connect: ' + error.message, 'error');
            }
        }
    }
    
    async function loadFromMasterFile() {
        if (!masterFileHandle) {
            console.warn('‚ö†Ô∏è No master file connected');
            return false;
        }
        
        try {
            const file = await masterFileHandle.getFile();
            const text = await file.text();
            const data = JSON.parse(text);
            
            // COLLISION DETECTION: Store file timestamp and metadata version
            loadedFileTimestamp = file.lastModified;
            loadedMetadataVersion = data._metadata?.version || 0;
            
            // Initialize masterJsonData for activity logging
            masterJsonData = data;
            if (!masterJsonData._activityLog) {
                masterJsonData._activityLog = [];
            }
            
            // Handle data structure
            const inventory = data.inventory || [];
            
            state.products = inventory.map(i => {
                // Channel allocations are in i.channels object (qty allocated to each channel)
                const channels = i.channels || {};
                
                // Check if product is allocated to each channel (qty > 0 means listed)
                const hasEtsy = (channels.etsy > 0) || !!i.etsyListingId;
                const hasWix = (channels.wix > 0) || !!i.wixProductId;
                const hasWayfair = (channels.wayfair > 0) || !!i.wayfairSku;
                
                // Get channel IDs if they exist
                const etsyId = i.etsyListingId || null;
                const wixId = i.wixProductId || null;
                const wayfairSku = i.wayfairSku || i.sku; // Use product SKU as wayfair SKU if allocated
                
                // Channel quantities from channels object
                const etsyQty = channels.etsy || 0;
                const wixQty = channels.wix || 0;
                const wayfairQty = channels.wayfair || 0;
                
                // Base warehouse qty
                const baseQty = i.qty || i.warehouseQty || i.quantity || 0;
                
                return {
                    id: i.id || i.sku, 
                    sku: i.sku || i.SKU, 
                    name: i.productName || i.name || i.title,
                    description: i.description || i.productDescription || '', 
                    price: i.retailPrice || i.price || 0, 
                    quantity: baseQty,
                    // Channel mappings - truthy if allocated OR has ID
                    etsy: hasEtsy ? { id: etsyId, qty: etsyQty } : null,
                    wix: hasWix ? { id: wixId, qty: wixQty } : null,
                    wayfair: hasWayfair ? { sku: wayfairSku, qty: wayfairQty } : null,
                    // Quantities per channel
                    etsyQty: etsyQty,
                    wixQty: wixQty,
                    wayfairQty: wayfairQty,
                    wayfairSku: hasWayfair ? wayfairSku : null,
                    // Etsy specific fields
                    etsyListingId: etsyId,
                    etsyTitle: i.etsyTitle || null,
                    etsyPrice: i.etsyPrice || null,
                    // Full item for reference
                    _raw: i
                };
            });
            
            console.log('‚úÖ Loaded ' + state.products.length + ' products from master file');
            
            // Log channel stats
            const etsyCount = state.products.filter(p => p.etsy).length;
            const wixCount = state.products.filter(p => p.wix).length;
            const wayfairCount = state.products.filter(p => p.wayfair).length;
            console.log(`Channel allocations: Etsy=${etsyCount}, Wix=${wixCount}, Wayfair=${wayfairCount}`);
            
            // Log file connection to activity log
            logActivity('system', 'file_connected', 'system',
                `Channel Manager connected: ${state.products.length} products loaded`,
                { filename: masterFileHandle.name, productCount: state.products.length, etsy: etsyCount, wix: wixCount, wayfair: wayfairCount }
            );
            
            renderProducts();
            refreshDashboard();
            updateFileStatus();
            return true;
            
        } catch (error) {
            console.error('Failed to load from master file:', error);
            toast('‚ùå Failed to load file: ' + error.message, 'error');
            return false;
        }
    }
    
    async function tryReconnectMasterFile() {
        try {
            // v2.3: Check Command Center shared files first
            if (typeof CCDSharedFiles !== 'undefined') {
                const sharedHandle = await CCDSharedFiles.getMasterJson();
                if (sharedHandle) {
                    masterFileHandle = sharedHandle;
                    await loadFromMasterFile();
                    console.log('[Master] ‚úÖ Connected via Command Center shared files');
                    return true;
                }
            }
            
            // Fall back to own stored handle
            const handle = await loadMasterFileHandle();
            if (!handle) {
                console.log('[Master] No saved file handle - first time setup required');
                return false;
            }
            
            console.log('[Master] Found saved file handle, checking permission...');
            // Verify permission
            const permission = await handle.queryPermission({ mode: 'read' });
            console.log('[Master] Permission status:', permission);
            
            if (permission === 'granted') {
                masterFileHandle = handle;
                await loadFromMasterFile();
                console.log('[Master] ‚úÖ Auto-reconnected successfully');
                return true;
            } else if (permission === 'prompt') {
                console.log('[Master] Permission needed - requesting...');
                try {
                    const newPerm = await handle.requestPermission({ mode: 'read' });
                    if (newPerm === 'granted') {
                        masterFileHandle = handle;
                        await loadFromMasterFile();
                        console.log('[Master] ‚úÖ Permission granted - reconnected');
                        return true;
                    } else {
                        console.log('[Master] ‚ùå Permission denied by user');
                        return false;
                    }
                } catch (permErr) {
                    console.error('[Master] ‚ùå Permission request failed:', permErr);
                    return false;
                }
            } else {
                console.log('[Master] ‚ùå Permission denied - manual reconnect required');
                return false;
            }
            
        } catch (error) {
            console.error('[Master] ‚ùå Auto-reconnect error:', error);
            return false;
        }
    }
    
    async function tryReconnectOneDriveFolder() {
        try {
            const handle = await loadOneDriveFolderHandle();
            if (!handle) {
                console.log('[OneDrive] No folder handle saved - first time setup required');
                return false;
            }
            
            console.log('[OneDrive] Found saved folder handle, checking permission...');
            // Verify permission
            const permission = await handle.queryPermission({ mode: 'read' });
            console.log('[OneDrive] Permission status:', permission);
            
            if (permission === 'granted') {
                oneDriveFolderHandle = handle;
                updateOneDriveStatus();
                console.log('[OneDrive] ‚úÖ Auto-reconnected to folder:', handle.name);
                return true;
            } else if (permission === 'prompt') {
                console.log('[OneDrive] Permission needed - requesting...');
                try {
                    const newPerm = await handle.requestPermission({ mode: 'read' });
                    if (newPerm === 'granted') {
                        oneDriveFolderHandle = handle;
                        updateOneDriveStatus();
                        console.log('[OneDrive] ‚úÖ Permission granted - reconnected to:', handle.name);
                        return true;
                    } else {
                        console.log('[OneDrive] ‚ùå Permission denied by user');
                        return false;
                    }
                } catch (permErr) {
                    console.error('[OneDrive] ‚ùå Permission request failed:', permErr);
                    return false;
                }
            } else {
                console.log('[OneDrive] ‚ùå Permission denied - manual reconnect required');
                return false;
            }
            
        } catch (error) {
            console.error('[OneDrive] ‚ùå Auto-reconnect error:', error);
            return false;
        }
    }
    
    function updateFileStatus() {
        const statusEl = document.getElementById('fileStatus');
        if (!statusEl) return;
        
        if (masterFileHandle) {
            const fileName = localStorage.getItem('masterFileName') || 'connected';
            statusEl.innerHTML = `‚úÖ <span style="color: var(--success);">${fileName}</span>`;
            statusEl.title = 'Connected to master file';
        } else {
            statusEl.innerHTML = `‚ö†Ô∏è <span style="color: var(--warning);">No file connected</span>`;
            statusEl.title = 'Click "Connect File" to select master JSON';
        }
    }
    
    // ============================================================
    // PRODUCT LOADING (Updated to use file first, then localStorage)
    // ============================================================
    
    function loadProducts() {
        // Try file first (preferred method)
        if (masterFileHandle) {
            console.log('Loading from master file...');
            // File loading is async, will be handled by loadFromMasterFile
            return;
        }
        
        // Fallback to localStorage (if Inventory System is open)
        const d = localStorage.getItem('ccdInventory') || localStorage.getItem('ccdInventoryData');
        if (d) {
            try {
                const data = JSON.parse(d);
                // Handle different data structures
                const inventory = data.inventory || data.items || [];
                state.products = inventory.map(i => ({
                    id: i.id || i.sku, 
                    sku: i.sku, 
                    name: i.productName || i.name,
                    description: i.description || '', 
                    price: i.retailPrice || i.price || 0, 
                    quantity: i.qty || i.warehouseQty || i.quantity || 0,
                    // Channel mappings from channels object
                    etsy: ((i.channels?.etsy > 0) || i.etsyListingId) ? { id: i.etsyListingId, qty: i.channels?.etsy || 0 } : null,
                    wix: ((i.channels?.wix > 0) || i.wixProductId) ? { id: i.wixProductId, qty: i.channels?.wix || 0 } : null,
                    wayfair: ((i.channels?.wayfair > 0) || i.wayfairSku) ? { sku: i.wayfairSku || i.sku, qty: i.channels?.wayfair || 0 } : null,
                    // Quantities per channel
                    etsyQty: i.channels?.etsy || 0,
                    wixQty: i.channels?.wix || 0,
                    wayfairQty: i.channels?.wayfair || 0,
                    wayfairSku: i.wayfairSku || null,
                    _raw: i
                }));
                console.log('‚úÖ Loaded ' + state.products.length + ' products from localStorage');
            } catch(e) { 
                console.error('Error parsing inventory data:', e); 
            }
        }
        
        if (!state.products.length) {
            console.warn('‚ö†Ô∏è No products found.');
            console.warn('üí° Click "üìÅ Connect File" to select your master JSON file');
            console.warn('üí° Or open Inventory System to load from localStorage');
            // Show helpful message
            state.products = [
                { id: 'help-1', sku: 'HELP', name: 'üëÜ Click "üìÅ Connect File" to load products', price: 0, quantity: 0, etsy: null, wix: null, wayfair: null }
            ];
        }
        renderProducts();
        refreshDashboard();
        updateFileStatus();
    }
    
    function renderProducts() {
        const list = document.getElementById('productList');
        const search = document.getElementById('searchInput').value.toLowerCase();
        const filtered = state.products.filter(p => {
            const m1 = !search || p.name?.toLowerCase().includes(search) || p.sku?.toLowerCase().includes(search);
            const m2 = state.filter === 'all' || (state.filter === 'etsy' && p.etsy) || (state.filter === 'wix' && p.wix) || (state.filter === 'wayfair' && p.wayfair);
            return m1 && m2;
        });
        list.innerHTML = filtered.map((p, idx) => `
            <div class="product-item ${state.selectedProduct?.sku === p.sku ? 'selected' : ''}" data-sku="${esc(p.sku)}" onclick="selectProductBySku(this.dataset.sku)">
                <div class="product-name">${esc(p.name)}</div>
                <div class="product-sku">${esc(p.sku)}</div>
                <div class="product-channels">
                    <span class="channel-dot ${p.etsy ? 'etsy' : 'none'}"></span>
                    <span class="channel-dot ${p.wix ? 'wix' : 'none'}"></span>
                    <span class="channel-dot ${p.wayfair ? 'wayfair' : 'none'}"></span>
                </div>
            </div>
        `).join('');
    }
    
    function filterProducts() { renderProducts(); }
    function setFilter(f) {
        state.filter = f;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter === f));
        renderProducts();
    }
    
    function selectProduct(id) { state.selectedProduct = state.products.find(p => p.id === id); renderProducts(); renderProductDetail(); }
    function selectProductBySku(sku) { 
        state.selectedProduct = state.products.find(p => p.sku === sku); 
        if (!state.selectedProduct) {
            console.error('Product not found for SKU:', sku);
            toast('Product not found: ' + sku, 'error');
            return;
        }
        renderProducts(); 
        renderProductDetail(); 
    }
    
    function renderProductDetail() {
        const p = state.selectedProduct;
        const empty = document.getElementById('emptyState');
        const detail = document.getElementById('productDetail');
        if (!p) { empty.style.display = 'flex'; detail.classList.remove('active'); return; }
        empty.style.display = 'none'; detail.classList.add('active');
        document.getElementById('detailTitle').textContent = p.name;
        document.getElementById('detailSku').textContent = 'SKU: ' + p.sku;
        
        // Populate Master Data Panel
        document.getElementById('masterPrice').textContent = '$' + (p.price || 0).toFixed(2);
        document.getElementById('masterQty').textContent = p.quantity || 0;
        
        // Show Etsy ID or allocation status
        const etsyStatus = p.etsy?.id ? p.etsy.id : (p.etsy ? `Allocated (${p.etsyQty})` : 'Not Allocated');
        document.getElementById('masterEtsyId').textContent = etsyStatus;
        document.getElementById('masterEtsyId').style.color = p.etsy ? 'var(--etsy)' : 'var(--text-dim)';
        
        // Show Wix ID or allocation status
        const wixStatus = p.wix?.id ? p.wix.id : (p.wix ? `Allocated (${p.wixQty})` : 'Not Allocated');
        document.getElementById('masterWixId').textContent = wixStatus;
        document.getElementById('masterWixId').style.color = p.wix ? 'var(--wix)' : 'var(--text-dim)';
        
        // Show Wayfair SKU or allocation status
        const wayfairStatus = p.wayfair?.sku ? p.wayfair.sku : (p.wayfair ? `Allocated (${p.wayfairQty})` : 'Not Allocated');
        document.getElementById('masterWayfairSku').textContent = wayfairStatus;
        document.getElementById('masterWayfairSku').style.color = p.wayfair ? 'var(--wayfair)' : 'var(--text-dim)';
        
        const setCell = (id, val) => {
            const cell = document.getElementById(id);
            cell.innerHTML = `<div class="field-value">${val || '-'}</div>`;
            if (!val) cell.classList.add('empty'); else cell.classList.remove('empty');
        };
        const setStatus = (id, listed) => {
            const el = document.getElementById(id);
            el.className = 'channel-status ' + (listed ? 'connected' : 'not-listed');
            el.textContent = listed ? 'Listed' : 'Not Listed';
        };
        
        // Use Etsy-specific title/price if available, otherwise use master
        const etsyTitle = p._raw?.etsyTitle || p.name;
        const etsyPrice = p._raw?.etsyPrice || p.price;
        
        setCell('etsyTitle', p.etsy ? etsyTitle : ''); 
        setCell('wixTitle', p.wix ? p.name : ''); 
        setCell('wayfairTitle', p.wayfair ? p.name : '');
        
        setCell('etsyDesc', p.etsy ? (p.description?.substring(0, 50) || 'Yes') : ''); 
        setCell('wixDesc', p.wix ? 'Yes' : ''); 
        setCell('wayfairDesc', p.wayfair ? 'Yes' : '');
        
        setCell('etsyPrice', p.etsy ? '$' + (etsyPrice || 0).toFixed(2) : ''); 
        setCell('wixPrice', p.wix ? '$' + (p.price || 0).toFixed(2) : ''); 
        setCell('wayfairPrice', p.wayfair ? '$' + (p.price || 0).toFixed(2) : '');
        
        // Show allocated quantities from channels object
        setCell('etsyQty', p.etsy ? p.etsyQty : ''); 
        setCell('wixQty', p.wix ? p.wixQty : ''); 
        setCell('wayfairQty', p.wayfair ? p.wayfairQty : '');
        
        setCell('etsyStatusCell', p.etsy ? 'Active' : ''); 
        setCell('wixStatusCell', p.wix ? 'Active' : ''); 
        setCell('wayfairStatusCell', p.wayfair ? 'Active' : '');
        
        setStatus('etsyListingStatus', p.etsy); 
        setStatus('wixListingStatus', p.wix); 
        setStatus('wayfairListingStatus', p.wayfair);
    }
    
    function pushToChannel(ch) {
        if (!state.selectedProduct) { toast('Select a product first', 'error'); return; }
        state.pushTarget = ch;
        document.getElementById('pushModalTitle').textContent = { etsy: 'üè† Push to Etsy', wix: 'üåê Push to Wix', wayfair: 'üõí Push to Wayfair' }[ch];
        document.getElementById('pushBtn').className = 'btn btn-' + ch;
        openModal('pushModal');
    }
    
    function executePush() {
        const p = state.selectedProduct, ch = state.pushTarget;
        const fields = [];
        if (document.getElementById('pushTitle').checked) fields.push('title');
        if (document.getElementById('pushDesc').checked) fields.push('description');
        if (document.getElementById('pushPrice').checked) fields.push('price');
        if (document.getElementById('pushQty').checked) fields.push('quantity');
        if (document.getElementById('pushImages').checked) fields.push('images');
        if (document.getElementById('pushVar').checked) fields.push('variations');
        const action = document.getElementById('pushAction').value;
        if (ch === 'wayfair' && fields.includes('quantity')) pushToWayfairInventory();
        state.syncQueue.push({ id: Date.now(), product: p, channel: ch, fields, action, status: 'pending' });
        saveSyncQueue(); // Save to localStorage for Sync Hub
        closeModal('pushModal');
        toast(`Added to ${ch} queue`, 'success');
        
        // Log push queued to activity log
        logActivity('sync', 'push_queued', ch,
            `Queued push for ${p.sku} to ${ch} (${fields.join(', ')})`,
            { sku: p.sku, channel: ch, fields: fields, action: action }
        );
    }
    
    function selectAllFields() { document.querySelectorAll('.sync-panel-body input[type="checkbox"]').forEach(c => c.checked = true); }
    function previewSync() { const fields = getSyncFields(); let msg = 'Preview:\n'; for (const [f, t] of Object.entries(fields)) if (t.length) msg += `${f} ‚Üí ${t.join(', ')}\n`; alert(msg || 'No fields selected'); }
    
    function executeSync() {
        const p = state.selectedProduct;
        if (!p) { toast('Select a product', 'error'); return; }
        const fields = getSyncFields();
        let count = 0;
        for (const [field, targets] of Object.entries(fields)) {
            for (const ch of targets) {
                state.syncQueue.push({ id: Date.now() + Math.random(), product: p, channel: ch, field, action: p[ch] ? 'update' : 'create', status: 'pending' });
                count++;
            }
        }
        if (count) { 
            saveSyncQueue(); // Save to localStorage for Sync Hub
            toast(`Added ${count} operations to queue`, 'success'); 
            document.querySelectorAll('.sync-panel-body input[type="checkbox"]').forEach(c => c.checked = false);
            
            // Log sync queued to activity log
            const targetChannels = [...new Set(Object.values(fields).flat())];
            logActivity('sync', 'sync_queued', 'system',
                `Queued ${count} sync operations for ${p.sku}`,
                { sku: p.sku, operationCount: count, channels: targetChannels, fields: Object.keys(fields).filter(f => fields[f].length > 0) }
            );
        }
        else { toast('Select fields and targets', 'warning'); }
    }
    
    function getSyncFields() {
        return { title: getTargets('syncTitle'), description: getTargets('syncDesc'), price: getTargets('syncPrice'), quantity: getTargets('syncQty'), images: getTargets('syncImages'), variations: getTargets('syncVar') };
    }
    
    function getTargets(pre) {
        const t = [];
        if (document.getElementById(pre + 'Etsy')?.checked) t.push('etsy');
        if (document.getElementById(pre + 'Wix')?.checked) t.push('wix');
        if (document.getElementById(pre + 'Wayfair')?.checked) t.push('wayfair');
        return t;
    }
    
    function loadSettings() {
        const s = localStorage.getItem('ccd_channel_manager_settings');
        if (s) Object.assign(state.settings, JSON.parse(s));
        const inv = localStorage.getItem('ccdInventorySettings');
        if (inv) { const i = JSON.parse(inv); if (i.etsyProxyUrl) state.settings.etsyProxyUrl = i.etsyProxyUrl; }
        document.getElementById('etsyProxyUrl').value = state.settings.etsyProxyUrl || '';
        document.getElementById('etsyShopId').value = state.settings.etsyShopId || '';
        document.getElementById('etsyApiKey').value = state.settings.etsyApiKey || '';
        // Wix settings
        const wxpu = document.getElementById('wixProxyUrl'), wxsi = document.getElementById('wixSiteId');
        if (wxpu) wxpu.value = state.settings.wixProxyUrl || '';
        if (wxsi) wxsi.value = state.settings.wixSiteId || '';
        // Wayfair settings
        const wpu = document.getElementById('wayfairProxyUrl'), wak = document.getElementById('wayfairApiKey'), wsi = document.getElementById('wayfairSupplierId');
        if (wpu) wpu.value = state.settings.wayfairProxyUrl || '';
        if (wak) wak.value = state.settings.wayfairApiKey || '';
        if (wsi) wsi.value = state.settings.wayfairSupplierId || '';
        updateWayfairEnvironmentBadges();
    }
    
    function saveSettings() {
        state.settings.etsyProxyUrl = document.getElementById('etsyProxyUrl').value;
        state.settings.etsyShopId = document.getElementById('etsyShopId').value;
        state.settings.etsyApiKey = document.getElementById('etsyApiKey').value;
        // Wix settings
        const wxpu = document.getElementById('wixProxyUrl'), wxsi = document.getElementById('wixSiteId');
        if (wxpu) state.settings.wixProxyUrl = wxpu.value.trim();
        if (wxsi) state.settings.wixSiteId = wxsi.value.trim();
        // Wayfair settings
        const wpu = document.getElementById('wayfairProxyUrl'), wak = document.getElementById('wayfairApiKey'), wsi = document.getElementById('wayfairSupplierId');
        if (wpu) state.settings.wayfairProxyUrl = wpu.value.trim();
        if (wak) state.settings.wayfairApiKey = wak.value.trim();
        if (wsi) state.settings.wayfairSupplierId = wsi.value.trim();
        localStorage.setItem('ccd_channel_manager_settings', JSON.stringify(state.settings));
        toast('Settings saved', 'success');
        testEtsy(true); testWix(true); testWayfair(true);
    }
    
    function resetSettings() { if (confirm('Reset?')) { localStorage.removeItem('ccd_channel_manager_settings'); location.reload(); } }
    
    async function testEtsy(silent) {
        const dot = document.getElementById('etsyStatusDot'), txt = document.getElementById('etsyStatusText');
        if (!state.settings.etsyProxyUrl) { dot.className = 'status-dot disconnected'; txt.textContent = 'Not configured'; return; }
        txt.textContent = 'Checking...';
        try {
            const url = state.settings.etsyProxyUrl + '?action=getShopInfo&key=' + encodeURIComponent(state.settings.etsyApiKey);
            const r = await fetch(url);
            const d = await r.json();
            if (d.success && d.shop) { 
                dot.className = 'status-dot connected'; 
                txt.textContent = 'Connected (' + (d.shop.shop_name || 'Shop') + ')'; 
                state.connections.etsy = true; 
                if (!silent) toast('Etsy connected!', 'success'); 
            }
            else throw new Error(d.error || 'Unknown error');
        } catch (err) { 
            dot.className = 'status-dot disconnected'; 
            txt.textContent = 'Failed'; 
            state.connections.etsy = false; 
            if (!silent) toast('Etsy: ' + (err.message || 'Connection failed'), 'error'); 
        }
    }
    
    async function testWix(silent) {
        const dot = document.getElementById('wixStatusDot'), txt = document.getElementById('wixStatusText');
        const dashDot = document.getElementById('dashWixStatus');
        if (!state.settings.wixProxyUrl) { 
            if (dot) { dot.className = 'status-dot disconnected'; }
            if (txt) { txt.textContent = 'Not configured'; }
            if (dashDot) { dashDot.innerHTML = '<span class="connection-dot disconnected"></span>Not configured'; }
            return; 
        }
        if (txt) txt.textContent = 'Checking...';
        try {
            // Use CCD API key for proxy auth
            const ccdKey = 'ccd_UhDRQOM9TIqfSLj9Kyj2IROPS8SQ1KU5';
            const url = state.settings.wixProxyUrl + '?action=test&key=' + encodeURIComponent(ccdKey);
            const r = await fetch(url);
            const d = await r.json();
            if (d.success) { 
                if (dot) dot.className = 'status-dot connected'; 
                if (txt) txt.textContent = 'Connected (' + (d.productsFound || 0) + ' products)'; 
                if (dashDot) dashDot.innerHTML = '<span class="connection-dot connected"></span>Connected';
                state.connections.wix = true; 
                if (!silent) toast('Wix connected! Found ' + (d.productsFound || 0) + ' products', 'success'); 
            }
            else throw new Error(d.error || 'Unknown error');
        } catch (err) { 
            if (dot) dot.className = 'status-dot disconnected'; 
            if (txt) txt.textContent = 'Failed'; 
            if (dashDot) dashDot.innerHTML = '<span class="connection-dot disconnected"></span>Failed';
            state.connections.wix = false; 
            if (!silent) toast('Wix: ' + (err.message || 'Connection failed'), 'error'); 
        }
    }
    
    function clearQueue() { state.syncQueue = []; saveSyncQueue(); toast('Queue cleared', 'success'); }
    
    async function processQueue() { 
        if (!state.syncQueue.length) { toast('Queue empty', 'info'); return; }
        const pending = state.syncQueue.filter(i => i.status === 'pending');
        let completed = 0, errors = 0;
        for (const item of pending) {
            try {
                if (item.channel === 'wayfair' && (item.action === 'inventory' || item.field === 'quantity')) await processWayfairInventory(item);
                item.status = 'completed';
                completed++;
                
                // Log individual success
                logActivity('sync', 'push_success', item.channel,
                    `Pushed ${item.product?.sku || 'item'} to ${item.channel}`,
                    { sku: item.product?.sku, channel: item.channel, action: item.action, fields: item.fields || item.field }
                );
            } catch (err) { 
                item.status = 'error'; 
                errors++;
                console.error('Queue item error:', err);
                
                // Log failure
                logActivity('error', 'push_failed', item.channel,
                    `Failed to push ${item.product?.sku || 'item'} to ${item.channel}: ${err.message}`,
                    { sku: item.product?.sku, channel: item.channel, error: err.message }
                );
            }
        }
        
        // Save activity log entries to disk
        if (masterFileHandle && masterJsonData) {
            try {
                const writable = await masterFileHandle.createWritable();
                await writable.write(JSON.stringify(masterJsonData, null, 2));
                await writable.close();
                console.log('‚úÖ Activity log saved after queue processing');
            } catch (saveErr) {
                console.error('Failed to save activity log:', saveErr);
            }
        }
        
        toast(`Processing ${state.syncQueue.length} items...`, 'info'); 
    }
    
    function loadSourceProducts() {
        const src = document.getElementById('createSource').value, sel = document.getElementById('createProduct');
        sel.innerHTML = '<option value="">Select...</option>';
        if (src === 'inventory' || src === 'etsy') state.products.forEach(p => sel.innerHTML += `<option value="${p.id}">${p.name} (${p.sku})</option>`);
    }
    
    function createListing() {
        const prod = document.getElementById('createProduct').value;
        if (!prod) { toast('Select a product', 'error'); return; }
        const targets = [];
        if (document.getElementById('createEtsy').checked) targets.push('etsy');
        if (document.getElementById('createWix').checked) targets.push('wix');
        if (document.getElementById('createWayfair').checked) targets.push('wayfair');
        if (!targets.length) { toast('Select target channel(s)', 'error'); return; }
        const p = state.products.find(x => x.id === prod);
        targets.forEach(ch => state.syncQueue.push({ id: Date.now(), product: p, channel: ch, action: 'create', status: 'pending' }));
        closeModal('createModal');
        toast(`Queued creation on ${targets.join(', ')}`, 'success');
        
        // Log listing creation queued
        logActivity('sync', 'listing_create_queued', 'system',
            `Queued new listing for ${p.sku} on ${targets.join(', ')}`,
            { sku: p.sku, channels: targets }
        );
    }
    
    function scrollToSync() { document.getElementById('syncPanel').scrollIntoView({ behavior: 'smooth' }); }
    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function refreshData() { 
        if (masterFileHandle) {
            loadFromMasterFile();
        } else {
            loadProducts(); 
        }
        testEtsy(true); testWix(true);
        if (state.connections.wayfair) fetchWayfairOrders(); 
        toast('üîÑ Refreshed', 'success'); 
    }
    function openInventory() { window.location.href = window.location.href.replace(/[^/]*$/, '') + 'CCD-INVENTORY-SYSTEM.html'; }
    function esc(s) { return s ? String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;') : ''; }
    function formatDate(d) { if (!d) return 'N/A'; try { return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); } catch { return d; } }
    function toast(msg, type = 'info') {
        const c = document.getElementById('toastContainer'), t = document.createElement('div');
        t.className = 'toast ' + type;
        t.innerHTML = `<span>${{success:'&#10003;',error:'&#10007;',warning:'&#9888;',info:'&#8505;'}[type]}</span><span>${msg}</span>`;
        c.appendChild(t);
        setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 3000);
    }

    // =============================================
    // PRODUCT EDITOR FUNCTIONS
    // =============================================
    
    let editorMode = 'edit'; // 'edit' or 'create'
    let editorOriginalSku = null;
    
    function openProductEditor(mode = 'edit') {
        editorMode = mode;
        const modal = document.getElementById('productEditorModal');
        const title = document.getElementById('editorModalTitle');
        const deleteBtn = document.getElementById('editorDeleteBtn');
        
        if (mode === 'create') {
            title.textContent = '‚ûï Create New Product';
            deleteBtn.style.display = 'none';
            clearEditorFields();
            editorOriginalSku = null;
        } else {
            title.textContent = 'üìù Edit Product';
            deleteBtn.style.display = 'block';
            if (state.selectedProduct) {
                populateEditorFromProduct(state.selectedProduct);
                editorOriginalSku = state.selectedProduct.sku;
            }
        }
        
        openModal('productEditorModal');
    }
    
    function clearEditorFields() {
        document.getElementById('editorSku').value = '';
        document.getElementById('editorName').value = '';
        document.getElementById('editorDescription').value = '';
        document.getElementById('editorPrice').value = '';
        document.getElementById('editorCost').value = '';
        document.getElementById('editorQty').value = '';
        document.getElementById('editorWeight').value = '';
        document.getElementById('editorLength').value = '';
        document.getElementById('editorWidth').value = '';
        document.getElementById('editorHeight').value = '';
        document.getElementById('editorEtsyId').value = '';
        document.getElementById('editorWixId').value = '';
        document.getElementById('editorWayfairSku').value = '';
        document.getElementById('editorImages').value = '';
        document.getElementById('editorCategory').value = '';
        document.getElementById('editorTags').value = '';
        document.getElementById('editorUpc').value = '';
        document.getElementById('editorVendor').value = '';
        document.getElementById('editorImagePreview').innerHTML = '';
    }
    
    function populateEditorFromProduct(p) {
        const raw = p._raw || {};
        
        document.getElementById('editorSku').value = p.sku || '';
        document.getElementById('editorName').value = p.name || raw.productName || '';
        document.getElementById('editorDescription').value = p.description || raw.description || '';
        document.getElementById('editorPrice').value = p.price || raw.retailPrice || '';
        document.getElementById('editorCost').value = raw.costPrice || raw.cost || '';
        document.getElementById('editorQty').value = p.quantity || raw.warehouseQty || '';
        document.getElementById('editorWeight').value = raw.weight || raw.shippingWeight || '';
        document.getElementById('editorLength').value = raw.length || raw.itemLength || '';
        document.getElementById('editorWidth').value = raw.width || raw.itemWidth || '';
        document.getElementById('editorHeight').value = raw.height || raw.itemHeight || '';
        document.getElementById('editorEtsyId').value = p.etsy?.id || raw.etsyListingId || '';
        document.getElementById('editorWixId').value = p.wix?.id || raw.wixProductId || '';
        document.getElementById('editorWayfairSku').value = p.wayfair?.sku || raw.wayfairSku || '';
        
        // Images
        const images = raw.images || raw.imageUrls || [];
        document.getElementById('editorImages').value = Array.isArray(images) ? images.join('\n') : '';
        updateImagePreview();
        
        // Additional fields
        document.getElementById('editorCategory').value = raw.category || '';
        document.getElementById('editorTags').value = Array.isArray(raw.tags) ? raw.tags.join(', ') : (raw.tags || '');
        document.getElementById('editorUpc').value = raw.upc || raw.barcode || '';
        document.getElementById('editorVendor').value = raw.vendor || raw.supplier || '';
    }
    
    function updateImagePreview() {
        const urls = document.getElementById('editorImages').value.split('\n').filter(u => u.trim());
        const preview = document.getElementById('editorImagePreview');
        preview.innerHTML = urls.slice(0, 5).map(url => `
            <div style="width: 60px; height: 60px; border-radius: 6px; overflow: hidden; border: 1px solid var(--border);">
                <img src="${esc(url.trim())}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 60 60%22><rect fill=%22%23333%22 width=%2260%22 height=%2260%22/><text x=%2230%22 y=%2235%22 fill=%22%23666%22 text-anchor=%22middle%22>?</text></svg>'">
            </div>
        `).join('');
    }
    
    async function saveProductFromEditor() {
        const sku = document.getElementById('editorSku').value.trim();
        const name = document.getElementById('editorName').value.trim();
        
        if (!sku) { toast('SKU is required', 'error'); return; }
        if (!name) { toast('Product name is required', 'error'); return; }
        
        // Build product object matching master JSON structure
        const productData = {
            sku: sku,
            productName: name,
            description: document.getElementById('editorDescription').value.trim(),
            retailPrice: parseFloat(document.getElementById('editorPrice').value) || 0,
            costPrice: parseFloat(document.getElementById('editorCost').value) || 0,
            warehouseQty: parseInt(document.getElementById('editorQty').value) || 0,
            weight: parseFloat(document.getElementById('editorWeight').value) || 0,
            length: parseFloat(document.getElementById('editorLength').value) || 0,
            width: parseFloat(document.getElementById('editorWidth').value) || 0,
            height: parseFloat(document.getElementById('editorHeight').value) || 0,
            etsyListingId: document.getElementById('editorEtsyId').value.trim() || null,
            wixProductId: document.getElementById('editorWixId').value.trim() || null,
            wayfairSku: document.getElementById('editorWayfairSku').value.trim() || null,
            images: document.getElementById('editorImages').value.split('\n').map(u => u.trim()).filter(u => u),
            category: document.getElementById('editorCategory').value.trim(),
            tags: document.getElementById('editorTags').value.split(',').map(t => t.trim()).filter(t => t),
            upc: document.getElementById('editorUpc').value.trim(),
            vendor: document.getElementById('editorVendor').value.trim(),
            lastModified: new Date().toISOString()
        };
        
        // Check if we can save to master file
        if (!masterFileHandle) {
            toast('No master file connected. Connect a file first.', 'error');
            return;
        }
        
        try {
            // ============================================================
            // COLLISION DETECTION - Check before saving
            // ============================================================
            const collisionCheck = await checkForCollision();
            
            if (collisionCheck.collision) {
                const action = await showCollisionDialog(collisionCheck);
                
                if (action === 'reload') {
                    await loadFromMasterFile();
                    toast('üîÑ File reloaded - please review and re-apply your changes', 'info');
                    return;
                } else if (action === 'cancel') {
                    return;
                }
                // action === 'overwrite' - continue with save
            }
            
            // Read current file
            const file = await masterFileHandle.getFile();
            const text = await file.text();
            const data = JSON.parse(text);
            
            // Find or create inventory array
            if (!data.inventory) data.inventory = [];
            
            // Find existing product by SKU
            const existingIndex = data.inventory.findIndex(p => p.sku === (editorOriginalSku || sku));
            
            const isUpdate = existingIndex >= 0;
            
            if (isUpdate) {
                // Update existing - merge with existing data
                data.inventory[existingIndex] = { ...data.inventory[existingIndex], ...productData };
            } else {
                // Add new
                productData.id = 'prod_' + Date.now();
                productData.dateAdded = new Date().toISOString();
                data.inventory.push(productData);
            }
            
            // ============================================================
            // Update metadata and change log
            // ============================================================
            data._metadata = data._metadata || {};
            data._metadata.version = (data._metadata.version || 0) + 1;
            data._metadata.lastModified = new Date().toISOString();
            data._metadata.lastModifiedBy = getAppIdentifier();
            data._metadata.lastAction = isUpdate ? `Product updated: ${sku}` : `Product created: ${sku}`;
            
            // Add to change log
            data._changeLog = data._changeLog || [];
            data._changeLog.unshift(createChangeLogEntry({
                changeType: 'manual',
                sku: sku,
                field: isUpdate ? 'product_update' : 'product_create',
                before: isUpdate ? 'existing' : null,
                after: 'modified',
                reason: isUpdate ? 'Product updated via Channel Manager' : 'Product created via Channel Manager'
            }));
            
            // Prune old change log entries
            pruneChangeLog(data);
            
            // Write back to file
            const writable = await masterFileHandle.createWritable();
            await writable.write(JSON.stringify(data, null, 2));
            await writable.close();
            
            // ============================================================
            // COLLISION DETECTION - Update tracking variables after save
            // ============================================================
            const newFile = await masterFileHandle.getFile();
            loadedFileTimestamp = newFile.lastModified;
            loadedMetadataVersion = data._metadata.version;
            
            toast(isUpdate ? '‚úÖ Product updated: ' + sku : '‚úÖ Product created: ' + sku, 'success');
            
            // Log to Activity Log
            if (typeof logActivity === 'function') {
                logActivity('inventory', isUpdate ? 'item_updated' : 'item_created', 'system',
                    `${isUpdate ? 'Updated' : 'Created'} ${sku} via Channel Manager`,
                    { sku: sku, source: 'channel_manager', action: isUpdate ? 'update' : 'create' }
                );
            }
            
            // Reload products
            await loadFromMasterFile();
            
            // Select the updated/new product
            selectProductBySku(sku);
            
            closeModal('productEditorModal');
            
        } catch (error) {
            console.error('Save error:', error);
            toast('‚ùå Failed to save: ' + error.message, 'error');
        }
    }
    
    async function deleteProductFromEditor() {
        const sku = document.getElementById('editorSku').value.trim();
        if (!sku) return;
        
        if (!confirm(`Are you sure you want to delete product "${sku}" from the master file?\n\nThis cannot be undone.`)) {
            return;
        }
        
        if (!masterFileHandle) {
            toast('No master file connected', 'error');
            return;
        }
        
        try {
            // ============================================================
            // COLLISION DETECTION - Check before deleting
            // ============================================================
            const collisionCheck = await checkForCollision();
            
            if (collisionCheck.collision) {
                const action = await showCollisionDialog(collisionCheck);
                
                if (action === 'reload') {
                    await loadFromMasterFile();
                    toast('üîÑ File reloaded - please review before deleting', 'info');
                    return;
                } else if (action === 'cancel') {
                    return;
                }
                // action === 'overwrite' - continue with delete
            }
            
            const file = await masterFileHandle.getFile();
            const text = await file.text();
            const data = JSON.parse(text);
            
            if (!data.inventory) {
                toast('No inventory data found', 'error');
                return;
            }
            
            const initialCount = data.inventory.length;
            data.inventory = data.inventory.filter(p => p.sku !== sku);
            
            if (data.inventory.length === initialCount) {
                toast('Product not found in file', 'warning');
                return;
            }
            
            // ============================================================
            // Update metadata and change log
            // ============================================================
            data._metadata = data._metadata || {};
            data._metadata.version = (data._metadata.version || 0) + 1;
            data._metadata.lastModified = new Date().toISOString();
            data._metadata.lastModifiedBy = getAppIdentifier();
            data._metadata.lastAction = `Product deleted: ${sku}`;
            
            // Add to change log
            data._changeLog = data._changeLog || [];
            data._changeLog.unshift(createChangeLogEntry({
                changeType: 'manual',
                sku: sku,
                field: 'product_delete',
                before: 'existing',
                after: null,
                reason: 'Product deleted via Channel Manager'
            }));
            
            // Prune old change log entries
            pruneChangeLog(data);
            
            // Write back
            const writable = await masterFileHandle.createWritable();
            await writable.write(JSON.stringify(data, null, 2));
            await writable.close();
            
            // ============================================================
            // COLLISION DETECTION - Update tracking variables after save
            // ============================================================
            const newFile = await masterFileHandle.getFile();
            loadedFileTimestamp = newFile.lastModified;
            loadedMetadataVersion = data._metadata.version;
            
            toast('üóëÔ∏è Product deleted: ' + sku, 'success');
            
            // Log to Activity Log
            if (typeof logActivity === 'function') {
                logActivity('inventory', 'item_deleted', 'system',
                    `Deleted ${sku} via Channel Manager`,
                    { sku: sku, source: 'channel_manager' }
                );
            }
            
            // Clear selection and reload
            state.selectedProduct = null;
            await loadFromMasterFile();
            renderProductDetail();
            
            closeModal('productEditorModal');
            
        } catch (error) {
            console.error('Delete error:', error);
            toast('‚ùå Failed to delete: ' + error.message, 'error');
        }
    }
    
    // Update Create Listing button to open the new editor
    function openCreateListing() {
        openProductEditor('create');
    }

    // =============================================
    // IMPORT & LINK FUNCTIONS
    // =============================================
    
    let importData = {
        channel: null,
        items: [],
        matched: [],
        newItems: [],
        alreadyLinked: []
    };
    
    async function previewEtsyImport() {
        await previewImport('etsy');
    }
    
    async function previewWixImport() {
        await previewImport('wix');
    }
    
    async function previewWayfairImport() {
        await previewImport('wayfair');
    }
    
    async function importFromEtsy() {
        await previewImport('etsy');
    }
    
    async function importFromWix() {
        await previewImport('wix');
    }
    
    async function importFromWayfair() {
        await previewImport('wayfair');
    }
    
    async function previewImport(channel) {
        if (!masterFileHandle) {
            toast('Please connect Master JSON file first', 'error');
            return;
        }
        
        const statusEl = document.getElementById(channel + 'ImportStatus');
        if (statusEl) statusEl.textContent = 'Fetching listings...';
        
        try {
            // Fetch listings from channel
            let listings = [];
            
            if (channel === 'etsy') {
                listings = await fetchEtsyListings();
            } else if (channel === 'wix') {
                listings = await fetchWixProducts();
            } else if (channel === 'wayfair') {
                listings = await fetchWayfairProducts();
            }
            
            if (!listings || listings.length === 0) {
                toast(`No listings found in ${channel}`, 'warning');
                if (statusEl) statusEl.textContent = 'No listings found';
                return;
            }
            
            // Analyze against master JSON
            const analysis = analyzeImport(channel, listings);
            
            importData = {
                channel: channel,
                items: listings,
                matched: analysis.matched,
                newItems: analysis.newItems,
                alreadyLinked: analysis.alreadyLinked
            };
            
            // Update modal
            document.getElementById('importModalTitle').textContent = `üì• Import from ${channel.charAt(0).toUpperCase() + channel.slice(1)}`;
            document.getElementById('importTotalCount').textContent = listings.length;
            document.getElementById('importMatchedCount').textContent = analysis.matched.length;
            document.getElementById('importNewCount').textContent = analysis.newItems.length;
            document.getElementById('importAlreadyLinkedCount').textContent = analysis.alreadyLinked.length;
            
            // Render preview table
            renderImportPreview();
            
            if (statusEl) statusEl.textContent = `Found ${listings.length} listings`;
            
            openModal('importPreviewModal');
            
        } catch (error) {
            console.error('Import preview error:', error);
            toast(`Failed to fetch ${channel} listings: ${error.message}`, 'error');
            if (statusEl) statusEl.textContent = 'Error: ' + error.message;
        }
    }
    
    async function fetchEtsyListings() {
        const url = state.settings.etsyProxyUrl;
        const key = state.settings.etsyApiKey || state.settings.ccdApiKey;
        
        if (!url) throw new Error('Etsy proxy not configured');
        
        const response = await fetch(`${url}?action=getActiveListings&key=${encodeURIComponent(key)}&limit=250`);
        const data = await response.json();
        
        if (!data.success) throw new Error(data.error || 'Failed to fetch listings');
        
        return (data.listings || []).map(l => ({
            channelId: l.listing_id || l.id,
            sku: l.sku || l.skus?.[0] || '',
            name: l.title || l.name,
            price: l.price?.amount || l.price || 0,
            quantity: l.quantity || 0,
            url: l.url,
            _raw: l
        }));
    }
    
    async function fetchWixProducts() {
        const url = state.settings.wixProxyUrl;
        const key = 'ccd_UhDRQOM9TIqfSLj9Kyj2IROPS8SQ1KU5';
        
        if (!url) throw new Error('Wix proxy not configured');
        
        const response = await fetch(`${url}?action=getProducts&key=${encodeURIComponent(key)}&limit=250`);
        const data = await response.json();
        
        if (!data.success) throw new Error(data.error || 'Failed to fetch products');
        
        return (data.products || []).map(p => ({
            channelId: p.id,
            sku: p.sku || '',
            name: p.name,
            price: p.price || 0,
            quantity: p.quantity || p.stock?.quantity || 0,
            _raw: p
        }));
    }
    
    async function fetchWayfairProducts() {
        // Wayfair doesn't have a simple "get all products" - we'd need inventory feed
        // For now, return empty or implement if API supports it
        toast('Wayfair product import not yet implemented', 'info');
        return [];
    }
    
    function analyzeImport(channel, listings) {
        const matched = [];
        const newItems = [];
        const alreadyLinked = [];
        
        const idField = {
            'etsy': 'etsyListingId',
            'wix': 'wixProductId',
            'wayfair': 'wayfairSku'
        }[channel];
        
        for (const listing of listings) {
            // Find matching product by SKU in master
            const masterProduct = state.products.find(p => 
                p.sku && listing.sku && 
                p.sku.toLowerCase() === listing.sku.toLowerCase()
            );
            
            if (masterProduct) {
                // Check if already linked
                const existingId = masterProduct._raw?.[idField] || masterProduct[idField];
                
                if (existingId) {
                    alreadyLinked.push({
                        listing: listing,
                        masterProduct: masterProduct,
                        action: 'skip',
                        reason: 'Already linked'
                    });
                } else {
                    matched.push({
                        listing: listing,
                        masterProduct: masterProduct,
                        action: 'link',
                        reason: 'SKU match - will link'
                    });
                }
            } else {
                // No SKU match - new product
                newItems.push({
                    listing: listing,
                    masterProduct: null,
                    action: 'create',
                    reason: 'New - will create in Master'
                });
            }
        }
        
        return { matched, newItems, alreadyLinked };
    }
    
    function renderImportPreview() {
        const tbody = document.getElementById('importPreviewBody');
        const allItems = [
            ...importData.matched.map(i => ({ ...i, status: 'match' })),
            ...importData.newItems.map(i => ({ ...i, status: 'new' })),
            ...importData.alreadyLinked.map(i => ({ ...i, status: 'linked' }))
        ];
        
        if (allItems.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: var(--text-dim);">No items to import</td></tr>';
            return;
        }
        
        tbody.innerHTML = allItems.map((item, idx) => {
            const statusColors = {
                'match': 'var(--success)',
                'new': 'var(--warning)',
                'linked': 'var(--text-dim)'
            };
            const statusIcons = {
                'match': 'üîó',
                'new': '‚ûï',
                'linked': '‚úì'
            };
            const disabled = item.status === 'linked' ? 'disabled' : '';
            const checked = item.status !== 'linked' ? 'checked' : '';
            
            return `
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 8px;">
                        <input type="checkbox" class="import-checkbox" data-idx="${idx}" ${checked} ${disabled}>
                    </td>
                    <td style="padding: 8px; font-family: monospace;">${esc(item.listing.sku || 'N/A')}</td>
                    <td style="padding: 8px;">${esc(item.listing.name?.substring(0, 50) || 'Unnamed')}${item.listing.name?.length > 50 ? '...' : ''}</td>
                    <td style="padding: 8px; font-family: monospace; font-size: 0.8rem;">${esc(String(item.listing.channelId))}</td>
                    <td style="padding: 8px;">
                        <span style="display: inline-flex; align-items: center; gap: 4px; color: ${statusColors[item.status]};">
                            ${statusIcons[item.status]} ${item.reason}
                        </span>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    function toggleAllImports() {
        const selectAll = document.getElementById('importSelectAll').checked;
        document.querySelectorAll('.import-checkbox:not([disabled])').forEach(cb => {
            cb.checked = selectAll;
        });
    }
    
    async function executeImport() {
        if (!masterFileHandle) {
            toast('No master file connected', 'error');
            return;
        }
        
        const createNew = document.getElementById('importCreateNew').checked;
        const checkboxes = document.querySelectorAll('.import-checkbox:checked');
        
        if (checkboxes.length === 0) {
            toast('No items selected', 'warning');
            return;
        }
        
        try {
            // ============================================================
            // COLLISION DETECTION - Check before importing
            // ============================================================
            const collisionCheck = await checkForCollision();
            
            if (collisionCheck.collision) {
                const action = await showCollisionDialog(collisionCheck);
                
                if (action === 'reload') {
                    await loadFromMasterFile();
                    toast('üîÑ File reloaded - please re-run the import', 'info');
                    closeModal('importPreviewModal');
                    return;
                } else if (action === 'cancel') {
                    return;
                }
                // action === 'overwrite' - continue with import
            }
            
            // Read current master file
            const file = await masterFileHandle.getFile();
            const text = await file.text();
            const data = JSON.parse(text);
            
            if (!data.inventory) data.inventory = [];
            
            const idField = {
                'etsy': 'etsyListingId',
                'wix': 'wixProductId',
                'wayfair': 'wayfairSku'
            }[importData.channel];
            
            let linked = 0, created = 0;
            
            // Build index of all items
            const allItems = [
                ...importData.matched.map(i => ({ ...i, status: 'match' })),
                ...importData.newItems.map(i => ({ ...i, status: 'new' })),
                ...importData.alreadyLinked.map(i => ({ ...i, status: 'linked' }))
            ];
            
            checkboxes.forEach(cb => {
                const idx = parseInt(cb.dataset.idx);
                const item = allItems[idx];
                if (!item) return;
                
                if (item.status === 'match') {
                    // Link to existing product
                    const masterIdx = data.inventory.findIndex(p => 
                        p.sku && item.listing.sku &&
                        p.sku.toLowerCase() === item.listing.sku.toLowerCase()
                    );
                    
                    if (masterIdx >= 0) {
                        data.inventory[masterIdx][idField] = String(item.listing.channelId);
                        data.inventory[masterIdx][importData.channel + 'LastSync'] = new Date().toISOString();
                        linked++;
                    }
                } else if (item.status === 'new' && createNew) {
                    // Create new product
                    const newProduct = {
                        id: 'prod_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                        sku: item.listing.sku || 'IMPORT_' + item.listing.channelId,
                        productName: item.listing.name,
                        description: item.listing._raw?.description || '',
                        retailPrice: parseFloat(item.listing.price) || 0,
                        warehouseQty: parseInt(item.listing.quantity) || 0,
                        [idField]: String(item.listing.channelId),
                        dateAdded: new Date().toISOString(),
                        importedFrom: importData.channel
                    };
                    data.inventory.push(newProduct);
                    created++;
                }
            });
            
            // ============================================================
            // Update metadata and change log
            // ============================================================
            data._metadata = data._metadata || {};
            data._metadata.version = (data._metadata.version || 0) + 1;
            data._metadata.lastModified = new Date().toISOString();
            data._metadata.lastModifiedBy = getAppIdentifier();
            data._metadata.lastAction = `Import from ${importData.channel}: ${linked} linked, ${created} created`;
            
            // Add to change log
            data._changeLog = data._changeLog || [];
            data._changeLog.unshift(createChangeLogEntry({
                changeType: 'sync',
                sku: 'bulk',
                field: 'import',
                before: null,
                after: `${linked} linked, ${created} created`,
                reason: `Bulk import from ${importData.channel}`
            }));
            
            // Prune old change log entries
            pruneChangeLog(data);
            
            // Save back to file
            const writable = await masterFileHandle.createWritable();
            await writable.write(JSON.stringify(data, null, 2));
            await writable.close();
            
            // ============================================================
            // COLLISION DETECTION - Update tracking variables after save
            // ============================================================
            const newFile = await masterFileHandle.getFile();
            loadedFileTimestamp = newFile.lastModified;
            loadedMetadataVersion = data._metadata.version;
            
            toast(`‚úÖ Import complete: ${linked} linked, ${created} created`, 'success');
            
            // Log import to activity log
            logActivity('sync', 'import_complete', importData.channel,
                `Imported from ${importData.channel}: ${linked} linked, ${created} created`,
                { channel: importData.channel, linked: linked, created: created, totalSelected: checkboxes.length }
            );
            
            // Reload products
            await loadFromMasterFile();
            
            closeModal('importPreviewModal');
            
        } catch (error) {
            console.error('Import error:', error);
            toast('‚ùå Import failed: ' + error.message, 'error');
        }
    }

    // =============================================
    // COMPARE & SYNC FUNCTIONS
    // =============================================
    
    const compareState = {
        etsyProducts: [],
        wixProducts: [],
        mergedProducts: [],
        selectedSkus: new Set(),
        currentSku: null,
        filter: 'all'
    };
    
    async function fetchChannelData() {
        toast('Fetching channel data...', 'info');
        
        try {
            await Promise.all([
                fetchEtsyForCompare(),
                fetchWixForCompare()
            ]);
            
            mergeCompareProducts();
            renderCompareTable();
            
            toast(`Loaded: ${compareState.etsyProducts.length} Etsy, ${compareState.wixProducts.length} Wix products`, 'success');
        } catch (error) {
            console.error('Fetch error:', error);
            toast('Failed to fetch channel data: ' + error.message, 'error');
        }
    }
    
    async function fetchEtsyForCompare() {
        const url = state.settings.etsyProxyUrl;
        const key = state.settings.etsyApiKey || 'ccd_UhDRQOM9TIqfSLj9Kyj2IROPS8SQ1KU5';
        
        if (!url) {
            console.warn('Etsy proxy not configured');
            return;
        }
        
        try {
            const response = await fetch(`${url}?action=getActiveListings&key=${encodeURIComponent(key)}&limit=250`);
            const data = await response.json();
            
            if (data.success && data.listings) {
                compareState.etsyProducts = data.listings.map(l => ({
                    listingId: l.listing_id || l.id,
                    sku: l.sku || l.skus?.[0] || '',
                    name: l.title,
                    description: l.description || '',
                    price: parseFloat(l.price?.amount || l.price || 0),
                    quantity: parseInt(l.quantity || 0),
                    _raw: l
                }));
            }
        } catch (err) {
            console.error('Etsy fetch error:', err);
        }
    }
    
    async function fetchWixForCompare() {
        const url = state.settings.wixProxyUrl;
        const key = 'ccd_UhDRQOM9TIqfSLj9Kyj2IROPS8SQ1KU5';
        
        if (!url) {
            console.warn('Wix proxy not configured');
            return;
        }
        
        try {
            const response = await fetch(`${url}?action=getProducts&key=${encodeURIComponent(key)}&limit=250`);
            const data = await response.json();
            
            if (data.success && data.products) {
                compareState.wixProducts = data.products.map(p => ({
                    productId: p.id,
                    sku: p.sku || '',
                    name: p.name,
                    description: p.description || '',
                    price: parseFloat(p.price || 0),
                    quantity: parseInt(p.quantity || 0),
                    _raw: p
                }));
            }
        } catch (err) {
            console.error('Wix fetch error:', err);
        }
    }
    
    function mergeCompareProducts() {
        const skuMap = new Map();
        
        // Add master products
        state.products.forEach(p => {
            skuMap.set(p.sku, {
                sku: p.sku,
                master: p,
                etsy: null,
                wix: null,
                hasDifferences: false,
                status: 'ok'
            });
        });
        
        // Match Etsy by SKU
        compareState.etsyProducts.forEach(p => {
            if (p.sku && skuMap.has(p.sku)) {
                skuMap.get(p.sku).etsy = p;
            } else if (p.sku) {
                skuMap.set(p.sku, { sku: p.sku, master: null, etsy: p, wix: null, hasDifferences: true, status: 'etsy-only' });
            }
        });
        
        // Match Wix by SKU
        compareState.wixProducts.forEach(p => {
            if (p.sku && skuMap.has(p.sku)) {
                skuMap.get(p.sku).wix = p;
            } else if (p.sku) {
                if (skuMap.has(p.sku)) {
                    skuMap.get(p.sku).wix = p;
                } else {
                    skuMap.set(p.sku, { sku: p.sku, master: null, etsy: null, wix: p, hasDifferences: true, status: 'wix-only' });
                }
            }
        });
        
        // Check for differences and update status
        skuMap.forEach(item => {
            const { master, etsy, wix } = item;
            
            // Check for missing in channel when allocated
            if (master?.etsy && !etsy) {
                item.status = 'missing-etsy';
                item.hasDifferences = true;
            } else if (master?.wix && !wix) {
                item.status = 'missing-wix';
                item.hasDifferences = true;
            }
            
            // Check price/qty differences
            if (master && etsy && Math.abs(master.price - etsy.price) > 0.01) item.hasDifferences = true;
            if (master && wix && Math.abs(master.price - wix.price) > 0.01) item.hasDifferences = true;
            if (master && etsy && master.etsyQty !== etsy.quantity) item.hasDifferences = true;
            if (master && wix && master.wixQty !== wix.quantity) item.hasDifferences = true;
        });
        
        compareState.mergedProducts = Array.from(skuMap.values());
    }
    
    function renderCompareTable() {
        const tbody = document.getElementById('compareTableBody');
        
        let filtered = compareState.mergedProducts.filter(p => {
            if (compareState.filter === 'all') return true;
            if (compareState.filter === 'differences') return p.hasDifferences;
            if (compareState.filter === 'etsy-only') return p.etsy && !p.master;
            if (compareState.filter === 'wix-only') return p.wix && !p.master;
            if (compareState.filter === 'missing') return p.status.startsWith('missing');
            return true;
        });
        
        if (filtered.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8" style="padding: 40px; text-align: center; color: var(--text-dim);">No products match the filter</td></tr>`;
            return;
        }
        
        tbody.innerHTML = filtered.map(p => {
            const name = p.master?.name || p.etsy?.name || p.wix?.name || 'Unknown';
            const isSelected = compareState.selectedSkus.has(p.sku);
            
            const masterCell = p.master ? `$${p.master.price.toFixed(2)} / ${p.master.quantity}` : '<span style="color: var(--text-dim);">-</span>';
            const etsyCell = p.etsy ? `$${p.etsy.price.toFixed(2)} / ${p.etsy.quantity}` : '<span style="color: var(--text-dim);">-</span>';
            const wixCell = p.wix ? `$${p.wix.price.toFixed(2)} / ${p.wix.quantity}` : '<span style="color: var(--text-dim);">-</span>';
            
            let statusBadge = '<span style="color: var(--success);">‚úì OK</span>';
            if (p.hasDifferences) {
                if (p.status === 'etsy-only') statusBadge = '<span style="color: var(--etsy);">Etsy Only</span>';
                else if (p.status === 'wix-only') statusBadge = '<span style="color: var(--wix);">Wix Only</span>';
                else if (p.status === 'missing-etsy') statusBadge = '<span style="color: var(--warning);">Missing Etsy</span>';
                else if (p.status === 'missing-wix') statusBadge = '<span style="color: var(--warning);">Missing Wix</span>';
                else statusBadge = '<span style="color: var(--warning);">‚ö†Ô∏è Diff</span>';
            }
            
            return `
                <tr style="border-bottom: 1px solid var(--border); ${p.hasDifferences ? 'background: rgba(234, 179, 8, 0.05);' : ''}">
                    <td style="padding: 10px;">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleCompareSelect('${esc(p.sku)}')">
                    </td>
                    <td style="padding: 10px; font-family: monospace; font-size: 0.8rem;">${esc(p.sku)}</td>
                    <td style="padding: 10px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${esc(name)}</td>
                    <td style="padding: 10px; text-align: center; font-size: 0.85rem;">${masterCell}</td>
                    <td style="padding: 10px; text-align: center; font-size: 0.85rem;">${etsyCell}</td>
                    <td style="padding: 10px; text-align: center; font-size: 0.85rem;">${wixCell}</td>
                    <td style="padding: 10px; text-align: center; font-size: 0.8rem;">${statusBadge}</td>
                    <td style="padding: 10px; text-align: center;">
                        <button class="btn btn-sm btn-secondary" onclick="showCompareDetail('${esc(p.sku)}')">üëÅÔ∏è</button>
                    </td>
                </tr>
            `;
        }).join('');
        
        updateCompareSelectedCount();
    }
    
    function setCompareFilter(f) {
        compareState.filter = f;
        document.querySelectorAll('[data-compare-filter]').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.compareFilter === f);
        });
        renderCompareTable();
    }
    
    function toggleCompareSelect(sku) {
        if (compareState.selectedSkus.has(sku)) {
            compareState.selectedSkus.delete(sku);
        } else {
            compareState.selectedSkus.add(sku);
        }
        updateCompareSelectedCount();
    }
    
    function toggleCompareSelectAll() {
        const selectAll = document.getElementById('compareSelectAll').checked;
        
        if (selectAll) {
            compareState.mergedProducts.forEach(p => {
                if (compareState.filter === 'all' || 
                    (compareState.filter === 'differences' && p.hasDifferences)) {
                    compareState.selectedSkus.add(p.sku);
                }
            });
        } else {
            compareState.selectedSkus.clear();
        }
        
        renderCompareTable();
    }
    
    function updateCompareSelectedCount() {
        document.getElementById('compareSelectedCount').textContent = compareState.selectedSkus.size + ' selected';
    }
    
    function showCompareDetail(sku) {
        const product = compareState.mergedProducts.find(p => p.sku === sku);
        if (!product) return;
        
        compareState.currentSku = sku;
        
        const panel = document.getElementById('compareDetailPanel');
        panel.style.display = 'block';
        
        document.getElementById('compareDetailTitle').textContent = product.master?.name || product.etsy?.name || product.wix?.name || sku;
        
        const renderColumn = (data, type) => {
            if (!data) return '<div style="color: var(--text-dim); font-style: italic;">Not in this channel</div>';
            
            const price = type === 'master' ? data.price : data.price;
            const qty = type === 'master' ? (data.etsyQty + ' E / ' + data.wixQty + ' W') : data.quantity;
            
            return `
                <div style="margin-bottom: 12px;">
                    <div style="font-size: 0.75rem; color: var(--text-dim); margin-bottom: 2px;">Price</div>
                    <div style="font-weight: 600;">$${price.toFixed(2)}</div>
                </div>
                <div style="margin-bottom: 12px;">
                    <div style="font-size: 0.75rem; color: var(--text-dim); margin-bottom: 2px;">Quantity</div>
                    <div style="font-weight: 600;">${qty}</div>
                </div>
                <div style="margin-bottom: 12px;">
                    <div style="font-size: 0.75rem; color: var(--text-dim); margin-bottom: 2px;">Name</div>
                    <div style="font-size: 0.85rem;">${esc(data.name || 'N/A')}</div>
                </div>
            `;
        };
        
        document.getElementById('compareDetailMaster').innerHTML = renderColumn(product.master, 'master');
        document.getElementById('compareDetailEtsy').innerHTML = renderColumn(product.etsy, 'etsy');
        document.getElementById('compareDetailWix').innerHTML = renderColumn(product.wix, 'wix');
        
        // Scroll to panel
        panel.scrollIntoView({ behavior: 'smooth' });
    }
    
    function openCompareFieldSelector() {
        openModal('compareFieldModal');
    }
    
    function previewCompareSync() {
        if (compareState.selectedSkus.size === 0) {
            toast('Select products first', 'warning');
            return;
        }
        
        const source = document.getElementById('compareSyncSource').value;
        const target = document.getElementById('compareSyncTarget').value;
        
        if (source === target) {
            toast('Source and target must be different', 'error');
            return;
        }
        
        const selected = compareState.mergedProducts.filter(p => compareState.selectedSkus.has(p.sku));
        
        let html = `
            <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-input); border-radius: 8px;">
                <strong>${selected.length} products</strong> will be synced from 
                <strong style="color: var(--${source === 'master' ? 'success' : source});">${source.toUpperCase()}</strong> ‚Üí 
                <strong style="color: var(--${target});">${target.toUpperCase()}</strong>
            </div>
            <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                <thead>
                    <tr style="background: var(--bg-input);">
                        <th style="padding: 8px; text-align: left;">SKU</th>
                        <th style="padding: 8px; text-align: left;">Name</th>
                        <th style="padding: 8px; text-align: left;">Action</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        selected.forEach(p => {
            const sourceData = p[source];
            const targetData = p[target];
            const action = targetData ? 'Update' : 'Create';
            const name = sourceData?.name || p.master?.name || 'Unknown';
            
            html += `
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 8px; font-family: monospace;">${esc(p.sku)}</td>
                    <td style="padding: 8px;">${esc(name.substring(0, 40))}${name.length > 40 ? '...' : ''}</td>
                    <td style="padding: 8px;"><span style="color: var(--${action === 'Create' ? 'success' : 'warning'})">${action}</span></td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        
        document.getElementById('compareSyncPreviewContent').innerHTML = html;
        openModal('compareSyncPreviewModal');
    }
    
    function confirmCompareSync() {
        closeModal('compareSyncPreviewModal');
        executeCompareSync();
    }
    
    async function executeCompareSync() {
        if (compareState.selectedSkus.size === 0) {
            toast('Select products first', 'warning');
            return;
        }
        
        const source = document.getElementById('compareSyncSource').value;
        const target = document.getElementById('compareSyncTarget').value;
        
        if (source === target) {
            toast('Source and target must be different', 'error');
            return;
        }
        
        // Get selected fields
        const fields = {
            title: document.getElementById('compareFieldTitle')?.checked ?? true,
            description: document.getElementById('compareFieldDescription')?.checked ?? false,
            price: document.getElementById('compareFieldPrice')?.checked ?? true,
            quantity: document.getElementById('compareFieldQuantity')?.checked ?? true
        };
        
        const selected = compareState.mergedProducts.filter(p => compareState.selectedSkus.has(p.sku));
        
        openModal('compareSyncProgressModal');
        
        let completed = 0, errors = 0;
        
        for (const product of selected) {
            const sourceData = product[source];
            
            if (!sourceData) {
                errors++;
                continue;
            }
            
            try {
                if (target === 'wix') {
                    await syncProductToWix(product, sourceData, fields);
                } else if (target === 'etsy') {
                    await syncProductToEtsy(product, sourceData, fields);
                }
                completed++;
            } catch (err) {
                console.error('Sync error:', err);
                errors++;
            }
            
            const progress = ((completed + errors) / selected.length * 100).toFixed(0);
            document.getElementById('compareSyncProgressBar').style.width = progress + '%';
            document.getElementById('compareSyncProgressText').textContent = `Processing ${completed + errors} of ${selected.length}...`;
            document.getElementById('compareSyncProgressDetails').textContent = `‚úÖ ${completed} succeeded, ‚ùå ${errors} failed`;
            
            await new Promise(r => setTimeout(r, 150));
        }
        
        closeModal('compareSyncProgressModal');
        toast(`Sync complete: ${completed} succeeded, ${errors} failed`, errors > 0 ? 'warning' : 'success');
        
        // Refresh
        await fetchChannelData();
    }
    
    async function syncProductToWix(product, sourceData, fields) {
        const url = state.settings.wixProxyUrl;
        const key = 'ccd_UhDRQOM9TIqfSLj9Kyj2IROPS8SQ1KU5';
        
        if (!url) throw new Error('Wix proxy not configured');
        
        const data = { sku: product.sku };
        if (product.wix?.productId) data.productId = product.wix.productId;
        
        if (fields.title) data.name = sourceData.name;
        if (fields.description) data.description = sourceData.description;
        if (fields.price) data.price = sourceData.price;
        if (fields.quantity) data.quantity = sourceData.quantity || sourceData.wixQty || 0;
        
        const response = await fetch(`${url}?action=syncProduct&key=${encodeURIComponent(key)}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (!result.success) throw new Error(result.error || 'Sync failed');
        return result;
    }
    
    async function syncProductToEtsy(product, sourceData, fields) {
        const url = state.settings.etsyProxyUrl;
        const key = state.settings.etsyApiKey || 'ccd_UhDRQOM9TIqfSLj9Kyj2IROPS8SQ1KU5';
        
        if (!url) throw new Error('Etsy proxy not configured');
        
        // For now, just update inventory if we have a listing ID
        if (product.etsy?.listingId && fields.quantity) {
            const data = {
                action: 'updateInventory',
                key: key,
                listing_id: product.etsy.listingId,
                quantity: sourceData.quantity || sourceData.etsyQty || 0,
                sku: product.sku
            };
            
            const response = await fetch(`${url}?${new URLSearchParams(data)}`);
            const result = await response.json();
            if (!result.success) throw new Error(result.error || 'Etsy sync failed');
            return result;
        }
        
        toast('Etsy create/update coming soon', 'info');
    }
    
    async function pushCompareProduct(target) {
        if (!compareState.currentSku) return;
        
        const product = compareState.mergedProducts.find(p => p.sku === compareState.currentSku);
        if (!product?.master) {
            toast('No master data for this product', 'error');
            return;
        }
        
        toast(`Pushing to ${target}...`, 'info');
        
        try {
            if (target === 'wix') {
                await syncProductToWix(product, product.master, { title: true, price: true, quantity: true });
            } else if (target === 'etsy') {
                await syncProductToEtsy(product, product.master, { title: true, price: true, quantity: true });
            }
            toast(`Pushed to ${target}`, 'success');
            await fetchChannelData();
        } catch (err) {
            toast('Push failed: ' + err.message, 'error');
        }
    }
    
    async function copyCompareProduct(from, to) {
        if (!compareState.currentSku) return;
        
        const product = compareState.mergedProducts.find(p => p.sku === compareState.currentSku);
        const sourceData = product?.[from];
        
        if (!sourceData) {
            toast(`No ${from} data for this product`, 'error');
            return;
        }
        
        toast(`Copying ${from} ‚Üí ${to}...`, 'info');
        
        try {
            if (to === 'wix') {
                await syncProductToWix(product, sourceData, { title: true, description: true, price: true, quantity: true });
            } else if (to === 'etsy') {
                await syncProductToEtsy(product, sourceData, { title: true, description: true, price: true, quantity: true });
            }
            toast(`Copied to ${to}`, 'success');
            await fetchChannelData();
        } catch (err) {
            toast('Copy failed: ' + err.message, 'error');
        }
    }

    // WAYFAIR API FUNCTIONS
    async function wayfairApiCall(action, params = {}, method = 'GET', body = null) {
        const { wayfairProxyUrl, wayfairApiKey } = state.settings;
        if (!wayfairProxyUrl) throw new Error('Proxy URL not configured');
        const queryParams = new URLSearchParams({ action, key: wayfairApiKey, ...params });
        const url = wayfairProxyUrl + '?' + queryParams;
        const options = { method };
        if (body && method === 'POST') { options.headers = { 'Content-Type': 'application/json' }; options.body = JSON.stringify(body); }
        const response = await fetch(url, options);
        return await response.json();
    }

    async function testWayfair(silent = false) {
        const { wayfairProxyUrl } = state.settings;
        if (!wayfairProxyUrl) { updateWayfairStatus(false, 'Not configured'); return; }
        updateWayfairStatus(null, 'Checking...');
        try {
            const result = await wayfairApiCall('testAuth');
            if (result.success) {
                state.connections.wayfair = true;
                state.settings.wayfairEnvironment = result.environment || 'sandbox';
                updateWayfairStatus(true, 'Connected (' + (result.environment || 'sandbox') + ')');
                updateWayfairEnvironmentBadges();
                if (!silent) toast('Wayfair connected!', 'success');
            } else { state.connections.wayfair = false; updateWayfairStatus(false, result.error || 'Auth failed'); if (!silent) toast('Wayfair auth failed', 'error'); }
        } catch (err) { state.connections.wayfair = false; updateWayfairStatus(false, 'Connection error'); if (!silent) toast('Wayfair error: ' + err.message, 'error'); }
    }

    function updateWayfairStatus(connected, text) {
        const dot = document.getElementById('wayfairStatusDot'), txt = document.getElementById('wayfairStatusText'), alert = document.getElementById('wayfairConnectionAlert');
        if (dot) dot.className = 'status-dot ' + (connected === null ? 'checking' : connected ? 'connected' : 'disconnected');
        if (txt) txt.textContent = text;
        if (alert) alert.style.display = connected ? 'none' : 'flex';
    }

    function updateWayfairEnvironmentBadges() {
        const env = state.settings.wayfairEnvironment, isSandbox = env === 'sandbox';
        const badge = isSandbox ? 'üß™ Sandbox' : 'üöÄ Production', cls = 'env-badge ' + (isSandbox ? 'sandbox' : 'production');
        const b1 = document.getElementById('wayfairEnvBadge'), b2 = document.getElementById('wayfairEnvBadgeSettings');
        if (b1) { b1.textContent = badge; b1.className = cls; }
        if (b2) { b2.textContent = badge; b2.className = cls; }
    }

    async function fetchWayfairOrders() {
        if (!state.connections.wayfair) { document.getElementById('wayfairConnectionAlert').style.display = 'flex'; toast('Connect to Wayfair first', 'warning'); return; }
        const icon = document.getElementById('ordersRefreshIcon');
        if (icon) icon.innerHTML = '<div class="spinner"></div>';
        try {
            const result = await wayfairApiCall('getOrders', { limit: '25', hasResponse: 'false' });
            if (result.success) { state.wayfairOrders = result.orders || []; renderWayfairOrders(); updateWayfairStats(); toast('Loaded ' + state.wayfairOrders.length + ' orders', 'success'); }
            else { toast('Failed: ' + (result.error || 'Unknown'), 'error'); }
        } catch (err) { toast('Error: ' + err.message, 'error'); }
        finally { if (icon) icon.textContent = 'üîÑ'; }
    }

    function updateWayfairStats() {
        const orders = state.wayfairOrders, totalItems = orders.reduce((sum, o) => sum + (o.products?.length || 0), 0);
        const so = document.getElementById('statNewOrders'), si = document.getElementById('statTotalItems');
        if (so) so.textContent = orders.length;
        if (si) si.textContent = totalItems;
    }

    function renderWayfairOrders() {
        const container = document.getElementById('wayfairOrdersList');
        if (!container) return;
        if (!state.wayfairOrders.length) { container.innerHTML = '<div class="empty-state" style="padding: 60px;"><div class="empty-state-icon">‚úÖ</div><div class="empty-state-title">No open orders</div><div style="color: var(--text-dim);">All caught up!</div></div>'; return; }
        container.innerHTML = state.wayfairOrders.map((order, idx) => `
            <div class="order-card" id="order-${idx}">
                <div class="order-card-header" onclick="toggleWayfairOrder(${idx})">
                    <div>
                        <div class="order-po">PO# ${esc(order.poNumber)}</div>
                        <div class="order-meta"><span>üìÖ ${formatDate(order.poDate)}</span><span>üì¶ ${order.products?.length || 0} items</span><span>üöö Ship by ${formatDate(order.estimatedShipDate)}</span></div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;"><span class="order-badge new">New</span><span>‚ñº</span></div>
                </div>
                <div class="order-card-body">
                    <div class="order-customer">
                        <div class="customer-info"><h4>üìç Ship To</h4><div><strong>${esc(order.customerName || 'N/A')}</strong></div><div>${esc(order.customerAddress1 || '')}</div><div>${esc(order.customerCity || '')}, ${esc(order.customerState || '')} ${esc(order.customerPostalCode || '')}</div></div>
                        <div class="customer-info"><h4>üìã Order Details</h4><div><strong>Supplier ID:</strong> ${order.supplierId || 'N/A'}</div><div><strong>Ship By:</strong> ${formatDate(order.estimatedShipDate)}</div></div>
                    </div>
                    <table class="order-items-table"><thead><tr><th>Part Number</th><th>Name</th><th>Qty</th><th>Price</th></tr></thead>
                    <tbody>${(order.products || []).map(p => `<tr><td style="font-family: 'JetBrains Mono', monospace;">${esc(p.partNumber)}</td><td>${esc(p.name || '-')}</td><td>${p.quantity}</td><td>$${(p.price || 0).toFixed(2)}</td></tr>`).join('')}</tbody></table>
                    <div class="order-actions">
                        <button class="btn btn-sm" style="background: var(--success); color: white;" onclick="openAcceptOrder(${idx})">‚úÖ Accept Order</button>
                        <button class="btn btn-sm btn-wayfair" onclick="openShipOrder(${idx})">üì¶ Ship Order</button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function toggleWayfairOrder(idx) { const card = document.getElementById('order-' + idx); if (card) card.classList.toggle('expanded'); }

    // ============================================================
    // UNIFIED ORDERS VIEW FUNCTIONS (v2.2)
    // ============================================================
    
    let ordersFilter = 'all';
    
    function filterOrders(channel) {
        ordersFilter = channel;
        // Update filter button states
        document.querySelectorAll('#ordersView .filter-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.channel === channel);
        });
        renderAllOrders();
    }
    
    function renderAllOrders() {
        const container = document.getElementById('allOrdersList');
        if (!container) return;
        
        // Filter orders based on selected channel
        let orders = state.orders.all;
        if (ordersFilter !== 'all') {
            orders = orders.filter(o => o.channel === ordersFilter);
        }
        
        if (!orders.length) {
            container.innerHTML = `
                <div class="empty-state" style="padding: 60px;">
                    <div class="empty-state-icon">‚úÖ</div>
                    <div class="empty-state-title">No orders found</div>
                    <div style="color: var(--text-dim);">${syncDataFileHandle ? 'All caught up!' : 'Connect to ccd-sync-data.json to load orders'}</div>
                </div>`;
            return;
        }
        
        container.innerHTML = orders.map((order, idx) => {
            const channelColor = order.channel === 'etsy' ? 'var(--etsy)' : 
                                 order.channel === 'wix' ? 'var(--wix)' : 'var(--wayfair)';
            const channelIcon = order.channel === 'etsy' ? 'üõí' : 
                               order.channel === 'wix' ? 'üåê' : 'üè†';
            const orderId = order.id || order.poNumber || order.receipt_id || 'N/A';
            const orderDate = order.date || order.orderDate || order.poDate || order.createdDate;
            const total = order.total || order.grandTotal || 0;
            const items = order.items || order.products || [];
            const buyer = order.buyer || order.customerName || 'Unknown';
            
            return `
                <div class="order-card" style="margin-bottom: 12px; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border); overflow: hidden;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; cursor: pointer; border-left: 4px solid ${channelColor};" onclick="toggleOrder(${idx})">
                        <div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1.2rem;">${channelIcon}</span>
                                <span style="font-weight: 700; color: ${channelColor};">${order.channel.toUpperCase()}</span>
                                <span style="font-family: 'JetBrains Mono', monospace; color: var(--text-dim);">#${esc(orderId)}</span>
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-dim); margin-top: 4px;">
                                üìÖ ${formatDate(orderDate)} ‚Ä¢ üë§ ${esc(buyer)} ‚Ä¢ üì¶ ${items.length} items ‚Ä¢ üí∞ $${total.toFixed(2)}
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span class="order-badge" style="background: ${channelColor}22; color: ${channelColor};">${order.processed ? 'Processed' : 'New'}</span>
                            <span style="color: var(--text-dim);">‚ñº</span>
                        </div>
                    </div>
                    <div class="order-detail" id="orderDetail-${idx}" style="display: none; padding: 16px; border-top: 1px solid var(--border); background: var(--bg-dark);">
                        <table style="width: 100%; font-size: 0.85rem;">
                            <thead>
                                <tr style="color: var(--text-dim); text-align: left;">
                                    <th style="padding: 8px 12px;">SKU</th>
                                    <th style="padding: 8px 12px;">Name</th>
                                    <th style="padding: 8px 12px;">Qty</th>
                                    <th style="padding: 8px 12px;">Price</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.map(item => `
                                    <tr>
                                        <td style="padding: 8px 12px; font-family: 'JetBrains Mono', monospace;">${esc(item.sku || item.partNumber || '-')}</td>
                                        <td style="padding: 8px 12px;">${esc(item.name || item.title || '-')}</td>
                                        <td style="padding: 8px 12px;">${item.qty || item.quantity || 1}</td>
                                        <td style="padding: 8px 12px;">$${(item.price || item.unitPrice || 0).toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    function toggleOrder(idx) {
        const detail = document.getElementById('orderDetail-' + idx);
        if (detail) {
            detail.style.display = detail.style.display === 'none' ? 'block' : 'none';
        }
    }
    
    function updateOrderStats() {
        const setEl = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
        setEl('statAllOrders', state.orders.all.length);
        setEl('statEtsyOrders', state.orders.etsy.length);
        setEl('statWixOrders', state.orders.wix.length);
        setEl('statWayfairOrders', state.orders.wayfair.length);
    }

    function openAcceptOrder(idx) {
        state.currentOrder = state.wayfairOrders[idx];
        const order = state.currentOrder;
        document.getElementById('acceptOrderPO').textContent = order.poNumber;
        document.getElementById('acceptShipDate').value = new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        document.getElementById('acceptOrderItems').innerHTML = `<table class="order-items-table"><thead><tr><th>Part #</th><th>Qty</th><th>Price</th><th>Accept</th></tr></thead><tbody>${(order.products || []).filter(p => !p.isCancelled).map((p, i) => `<tr><td style="font-family: monospace;">${esc(p.partNumber)}</td><td>${p.quantity}</td><td>$${(p.price || 0).toFixed(2)}</td><td><input type="checkbox" id="acceptItem${i}" checked></td></tr>`).join('')}</tbody></table>`;
        openModal('acceptOrderModal');
    }

    async function confirmAcceptOrder() {
        const order = state.currentOrder;
        if (!order) return;
        const shipDate = document.getElementById('acceptShipDate').value;
        if (!shipDate) { toast('Please set a ship date', 'warning'); return; }
        const lineItems = (order.products || []).filter((p, i) => !p.isCancelled && document.getElementById('acceptItem' + i)?.checked).map(p => ({ partNumber: p.partNumber, quantity: parseInt(p.quantity), unitPrice: p.price, estimatedShipDate: shipDate + 'T12:00:00Z' }));
        if (!lineItems.length) { toast('Select at least one item', 'warning'); return; }
        try {
            const result = await wayfairApiCall('acceptOrder', {}, 'POST', { poNumber: order.poNumber, shipSpeed: 'GROUND', lineItems });
            if (result.success) { toast('Order accepted!', 'success'); closeModal('acceptOrderModal'); fetchWayfairOrders(); }
            else { toast('Failed: ' + (result.error || 'Unknown error'), 'error'); }
        } catch (err) { toast('Error: ' + err.message, 'error'); }
    }

    function openShipOrder(idx) {
        state.currentOrder = state.wayfairOrders[idx];
        const order = state.currentOrder;
        document.getElementById('shipOrderPO').textContent = order.poNumber;
        document.getElementById('shipDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('shipTrackingNumber').value = '';
        document.getElementById('shipPackageCount').value = '1';
        document.getElementById('shipOrderItems').innerHTML = `<h4 style="margin-top: 20px; margin-bottom: 12px;">üì¶ Items to Ship</h4><table class="order-items-table"><thead><tr><th>Part #</th><th>Qty</th><th>Ship</th></tr></thead><tbody>${(order.products || []).filter(p => !p.isCancelled).map((p, i) => `<tr><td style="font-family: monospace;">${esc(p.partNumber)}</td><td>${p.quantity}</td><td><input type="checkbox" id="shipItem${i}" checked></td></tr>`).join('')}</tbody></table>`;
        openModal('shipOrderModal');
    }

    async function confirmShipOrder() {
        const order = state.currentOrder;
        if (!order) return;
        const trackingNumber = document.getElementById('shipTrackingNumber').value.trim();
        const carrierCode = document.getElementById('shipCarrierCode').value;
        const shipSpeed = document.getElementById('shipSpeed').value;
        const shipDate = document.getElementById('shipDate').value;
        const packageCount = parseInt(document.getElementById('shipPackageCount').value) || 1;
        if (!trackingNumber) { toast('Enter a tracking number', 'warning'); return; }
        const items = (order.products || []).filter((p, i) => !p.isCancelled && document.getElementById('shipItem' + i)?.checked).map(p => ({ partNumber: p.partNumber, quantity: parseInt(p.quantity) }));
        if (!items.length) { toast('Select at least one item', 'warning'); return; }
        try {
            const result = await wayfairApiCall('createShipment', {}, 'POST', { poNumber: order.poNumber, supplierId: order.supplierId || parseInt(state.settings.wayfairSupplierId), trackingNumber, carrierCode, shipSpeed, shipDate: shipDate + 'T12:00:00Z', packageCount, items });
            if (result.success) { toast('ASN sent successfully!', 'success'); closeModal('shipOrderModal'); fetchWayfairOrders(); }
            else { toast('Failed: ' + (result.error || 'Unknown error'), 'error'); }
        } catch (err) { toast('Error: ' + err.message, 'error'); }
    }

    async function pushToWayfairInventory() {
        if (!state.selectedProduct) { toast('Select a product first', 'error'); return; }
        if (!state.connections.wayfair) { toast('Connect to Wayfair first', 'warning'); return; }
        const p = state.selectedProduct;
        if (!p.wayfairSku && !p.sku) { toast('Product needs a Wayfair SKU', 'warning'); return; }
        state.syncQueue.push({ id: Date.now(), product: p, channel: 'wayfair', action: 'inventory', fields: { quantity: true }, status: 'pending' });
        toast('Added to Wayfair inventory queue', 'success');
    }

    async function processWayfairInventory(item) {
        const { wayfairProxyUrl, wayfairApiKey, wayfairSupplierId } = state.settings;
        if (!wayfairProxyUrl) throw new Error('Proxy not configured');
        const inventory = [{ supplierPartNumber: item.product.wayfairSku || item.product.sku, quantityOnHand: item.product.wayfairQty || item.product.quantity, supplierId: parseInt(wayfairSupplierId) }];
        const response = await fetch(wayfairProxyUrl + '?action=updateInventory&key=' + wayfairApiKey, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ inventory, feedKind: 'DIFFERENTIAL' }) });
        const result = await response.json();
        if (!result.success) throw new Error(result.error || 'Failed');
        return result;
    }

    // ===== DASHBOARD FUNCTIONS =====
    function refreshDashboard() {
        updateDashboardStats();
        updateDashboardChannelStatus();
        checkSyncHubStatus();
    }

    function updateDashboardStats() {
        const totalProducts = state.products.length;
        const listedProducts = state.products.filter(p => 
            (p.etsyListing && p.etsyListing !== 'Not Listed') || 
            (p.wixListing && p.wixListing !== 'Not Listed') || 
            (p.wayfairListing && p.wayfairListing !== 'Not Listed')
        ).length;
        const pendingSyncs = state.syncQueue.filter(s => s.status === 'pending').length;

        const el = (id, val) => { const e = document.getElementById(id); if (e) e.textContent = val; };
        el('dashTotalProducts', totalProducts);
        el('dashListedProducts', listedProducts);
        el('dashPendingSyncs', pendingSyncs);

        // Update individual channel stats
        const etsyListed = state.products.filter(p => p.etsyListing && p.etsyListing !== 'Not Listed').length;
        const wixListed = state.products.filter(p => p.wixListing && p.wixListing !== 'Not Listed').length;
        const wayfairListed = state.products.filter(p => p.wayfairListing && p.wayfairListing !== 'Not Listed').length;

        const etsyPending = state.syncQueue.filter(s => s.channel === 'etsy' && s.status === 'pending').length;
        const wixPending = state.syncQueue.filter(s => s.channel === 'wix' && s.status === 'pending').length;
        const wayfairPending = state.syncQueue.filter(s => s.channel === 'wayfair' && s.status === 'pending').length;

        el('dashEtsyListed', etsyListed);
        el('dashWixListed', wixListed);
        el('dashWayfairListed', wayfairListed);
        el('dashEtsyPending', etsyPending);
        el('dashWixPending', wixPending);
        el('dashWayfairPending', wayfairPending);
    }

    /**
     * Check Sync Hub heartbeat status
     * This checks for a heartbeat written by Sync Hub to localStorage or shared CONFIG
     */
    async function checkSyncHubStatus() {
        const statusEl = document.getElementById('dashSyncHubStatus');
        const lastSeenEl = document.getElementById('dashSyncHubLastSeen');
        const alertBanner = document.getElementById('syncHubAlertBanner');
        const alertDetails = document.getElementById('syncHubAlertDetails');
        
        try {
            // Check localStorage for heartbeat (same-PC scenario)
            const heartbeat = localStorage.getItem('ccd_sync_hub_heartbeat');
            
            if (heartbeat) {
                const data = JSON.parse(heartbeat);
                const lastBeat = new Date(data.timestamp);
                const now = new Date();
                const minutesAgo = Math.round((now - lastBeat) / 1000 / 60);
                
                if (minutesAgo < 5) {
                    // Sync Hub is running and healthy
                    statusEl.textContent = '‚úÖ Running';
                    statusEl.style.color = 'var(--success)';
                    lastSeenEl.textContent = `Last seen: ${minutesAgo === 0 ? 'Just now' : minutesAgo + 'm ago'}`;
                    alertBanner.style.display = 'none';
                } else if (minutesAgo < 15) {
                    // Sync Hub might be stale
                    statusEl.textContent = '‚ö†Ô∏è Stale';
                    statusEl.style.color = 'var(--warning)';
                    lastSeenEl.textContent = `Last seen: ${minutesAgo}m ago`;
                    alertBanner.style.display = 'none';
                } else {
                    // Sync Hub is likely not running
                    statusEl.textContent = '‚ùå Not Running';
                    statusEl.style.color = 'var(--error)';
                    lastSeenEl.textContent = `Last seen: ${minutesAgo}m ago`;
                    alertBanner.style.display = 'block';
                    alertDetails.textContent = `Sync Hub hasn't checked in for ${minutesAgo} minutes. Auto-sync may not be running.`;
                }
            } else {
                // No heartbeat found - Sync Hub might be on different PC
                statusEl.textContent = '‚ùì Unknown';
                statusEl.style.color = 'var(--text-dim)';
                lastSeenEl.textContent = 'No heartbeat detected';
                alertBanner.style.display = 'none';
            }
        } catch (error) {
            console.error('Error checking Sync Hub status:', error);
            statusEl.textContent = '‚ùì Error';
            statusEl.style.color = 'var(--text-dim)';
            lastSeenEl.textContent = 'Could not check status';
        }
    }

    function updateDashboardChannelStatus() {
        const updateStatus = (id, connected) => {
            const el = document.getElementById(id);
            if (el) {
                el.className = 'connection-status ' + (connected ? 'connected' : 'disconnected');
                el.innerHTML = '<span class="connection-dot"></span><span>' + (connected ? 'Connected' : 'Not Connected') + '</span>';
            }
        };
        updateStatus('dashEtsyStatus', state.connections.etsy);
        updateStatus('dashWixStatus', state.connections.wix);
        updateStatus('dashWayfairStatus', state.connections.wayfair);
    }

    // ===== MULTI-CHANNEL PUSH FUNCTIONS =====
    let oneDriveFolderHandle = null;
    let currentProductImages = [];

    async function openMultiChannelPush() {
        if (!state.selectedProduct) {
            toast('Select a product first', 'warning');
            return;
        }

        const p = state.selectedProduct;
        document.getElementById('multiPushProductName').textContent = p.name;
        document.getElementById('multiPushProductSKU').textContent = p.sku;

        // Update channel statuses
        const setStatus = (id, listed) => {
            const el = document.getElementById(id);
            if (el) el.textContent = listed && listed !== 'Not Listed' ? 'Listed' : 'Not Listed';
        };
        setStatus('multiPushEtsyStatus', p.etsyListing);
        setStatus('multiPushWixStatus', p.wixListing);
        setStatus('multiPushWayfairStatus', p.wayfairListing);

        // Auto-check images if we have OneDrive folder
        const imagesCheckbox = document.getElementById('multiPushImages');
        if (imagesCheckbox && oneDriveFolderHandle) {
            imagesCheckbox.checked = true;
            await loadProductImages(p.sku);
        }

        openModal('multiChannelPushModal');
    }

    async function setupOneDriveFolder() {
        try {
            if ('showDirectoryPicker' in window) {
                oneDriveFolderHandle = await window.showDirectoryPicker();
                
                // Request permission
                const permission = await oneDriveFolderHandle.requestPermission({ mode: 'read' });
                if (permission !== 'granted') {
                    toast('‚ùå Permission denied', 'error');
                    return;
                }
                
                // Save to IndexedDB for persistence
                await saveOneDriveFolderHandle(oneDriveFolderHandle);
                localStorage.setItem('oneDriveFolderName', oneDriveFolderHandle.name);
                
                toast('‚úÖ OneDrive folder connected: ' + oneDriveFolderHandle.name, 'success');
                updateOneDriveStatus();
            } else {
                toast('File System Access API not supported in this browser', 'error');
            }
        } catch (err) {
            if (err.name !== 'AbortError') {
                toast('Error accessing folder: ' + err.message, 'error');
            }
        }
    }

    function updateOneDriveStatus() {
        const statusEl = document.getElementById('oneDriveStatus');
        if (statusEl) {
            if (oneDriveFolderHandle) {
                statusEl.innerHTML = '<span style="color: var(--success);">‚úì Connected: ' + oneDriveFolderHandle.name + '</span>';
            } else {
                const savedName = localStorage.getItem('oneDriveFolderName');
                if (savedName) {
                    statusEl.innerHTML = '<span style="color: var(--warning);">‚ö† Previously: ' + savedName + ' (click to reconnect)</span>';
                } else {
                    statusEl.innerHTML = '<span style="color: var(--text-dim);">Not configured</span>';
                }
            }
        }
    }

    async function loadProductImages(sku) {
        currentProductImages = [];
        const previewSection = document.getElementById('imagePreviewSection');
        const previewGrid = document.getElementById('imagePreviewGrid');
        const imageCount = document.getElementById('imageCount');

        if (!oneDriveFolderHandle) {
            if (previewSection) previewSection.style.display = 'none';
            return;
        }

        try {
            const imageExtensions = ['jpg', 'jpeg', 'png'];
            const imageFiles = [];

            // Look for SKU.jpg, SKU-2.jpg, SKU-3.jpg, etc. (up to 10 images)
            for (let i = 0; i < 10; i++) {
                const baseName = i === 0 ? sku : `${sku}-${i + 1}`;
                
                for (const ext of imageExtensions) {
                    const fileName = `${baseName}.${ext}`;
                    try {
                        const fileHandle = await oneDriveFolderHandle.getFileHandle(fileName);
                        const file = await fileHandle.getFile();
                        imageFiles.push(file);
                        break; // Found this index, move to next
                    } catch (err) {
                        // File doesn't exist, try next extension
                    }
                }
            }

            currentProductImages = imageFiles;

            if (imageFiles.length > 0) {
                if (previewSection) previewSection.style.display = 'block';
                if (imageCount) imageCount.textContent = `${imageFiles.length} image${imageFiles.length > 1 ? 's' : ''}`;
                
                if (previewGrid) {
                    previewGrid.innerHTML = '';
                    for (const file of imageFiles) {
                        const url = URL.createObjectURL(file);
                        const div = document.createElement('div');
                        div.className = 'image-preview-item';
                        div.innerHTML = `<img src="${url}" alt="${file.name}" onload="URL.revokeObjectURL(this.src)">`;
                        previewGrid.appendChild(div);
                    }
                }
            } else {
                if (previewSection) previewSection.style.display = 'none';
                toast('No images found for SKU: ' + sku, 'info');
            }
        } catch (err) {
            console.error('Error loading images:', err);
            if (previewSection) previewSection.style.display = 'none';
            toast('Error loading images: ' + err.message, 'error');
        }
    }

    async function executeMultiChannelPush() {
        const p = state.selectedProduct;
        if (!p) return;

        const channels = [];
        if (document.getElementById('multiPushEtsy')?.checked) channels.push('etsy');
        if (document.getElementById('multiPushWix')?.checked) channels.push('wix');
        if (document.getElementById('multiPushWayfair')?.checked) channels.push('wayfair');

        if (channels.length === 0) {
            toast('Select at least one channel', 'warning');
            return;
        }

        const fields = {
            title: document.getElementById('multiPushTitle')?.checked,
            description: document.getElementById('multiPushDesc')?.checked,
            price: document.getElementById('multiPushPrice')?.checked,
            quantity: document.getElementById('multiPushQty')?.checked,
            images: document.getElementById('multiPushImages')?.checked,
            variations: document.getElementById('multiPushVar')?.checked
        };

        const action = document.getElementById('multiPushAction')?.value || 'update';

        // Add to sync queue for each selected channel
        for (const channel of channels) {
            const queueItem = {
                id: Date.now() + Math.random(),
                product: p,
                channel: channel,
                action: action,
                fields: fields,
                status: 'pending',
                timestamp: new Date().toISOString()
            };

            // If images are selected and we have them, attach them
            if (fields.images && currentProductImages.length > 0) {
                queueItem.images = currentProductImages;
            }

            state.syncQueue.push(queueItem);
        }

        saveSyncQueue();
        toast(`Added ${channels.length} push operation${channels.length > 1 ? 's' : ''} to queue`, 'success');
        closeModal('multiChannelPushModal');
        refreshDashboard();
    }

    document.querySelectorAll('.modal-overlay').forEach(o => o.addEventListener('click', e => { if (e.target === o) o.classList.remove('active'); }));
    document.addEventListener('keydown', e => { if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active')); });

    </script>
</body>
</html>
